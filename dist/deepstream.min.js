!function(e){function t(i){if(n[i])return n[i].exports;var r=n[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var n={};t.m=e,t.c=n,t.d=function(e,n,i){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=10)}([function(e,t,n){"use strict";function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var r;Object.defineProperty(t,"__esModule",{value:!0});!function(e){e.payloadEncoding="e",e.name="n",e.names="m",e.subscription="s",e.correlationId="c",e.version="v",e.path="p",e.reason="r",e.url="u",e.originalTopic="t",e.originalAction="a"}(t.META_KEYS||(t.META_KEYS={}));!function(e){e.JSON="j",e.BINARY="b"}(t.PAYLOAD_ENCODING||(t.PAYLOAD_ENCODING={}));var o;!function(e){e[e.ERROR=0]="ERROR",e[e.PARSER=1]="PARSER",e[e.CONNECTION=2]="CONNECTION",e[e.AUTH=3]="AUTH",e[e.EVENT=4]="EVENT",e[e.RECORD=5]="RECORD",e[e.RPC=6]="RPC",e[e.PRESENCE=7]="PRESENCE",e[e.SUBSCRIPTIONS=16]="SUBSCRIPTIONS",e[e.ONLINE_USERS=17]="ONLINE_USERS",e[e.EVENT_SUBSCRIPTIONS=32]="EVENT_SUBSCRIPTIONS",e[e.RECORD_SUBSCRIPTIONS=33]="RECORD_SUBSCRIPTIONS",e[e.RPC_SUBSCRIPTIONS=34]="RPC_SUBSCRIPTIONS",e[e.PRESENCE_SUBSCRIPTIONS=35]="PRESENCE_SUBSCRIPTIONS",e[e.RECORD_LISTEN_PATTERNS=36]="RECORD_LISTEN_PATTERNS",e[e.EVENT_LISTEN_PATTERNS=37]="EVENT_LISTEN_PATTERNS",e[e.RECORD_PUBLISHED_SUBSCRIPTIONS=38]="RECORD_PUBLISHED_SUBSCRIPTIONS",e[e.EVENT_PUBLISHED_SUBSCRIPTIONS=39]="EVENT_PUBLISHED_SUBSCRIPTIONS",e[e.RECORD_LISTENING=40]="RECORD_LISTENING",e[e.EVENT_LISTENING=41]="EVENT_LISTENING"}(o=t.TOPIC||(t.TOPIC={}));var s;!function(e){e[e.UNKNOWN_TOPIC=80]="UNKNOWN_TOPIC",e[e.UNKNOWN_ACTION=81]="UNKNOWN_ACTION",e[e.INVALID_MESSAGE=82]="INVALID_MESSAGE",e[e.MESSAGE_PARSE_ERROR=83]="MESSAGE_PARSE_ERROR",e[e.MAXIMUM_MESSAGE_SIZE_EXCEEDED=84]="MAXIMUM_MESSAGE_SIZE_EXCEEDED",e[e.ERROR=85]="ERROR",e[e.INVALID_META_PARAMS=86]="INVALID_META_PARAMS"}(s=t.PARSER_ACTIONS||(t.PARSER_ACTIONS={}));var a;!function(e){e[e.ERROR=0]="ERROR",e[e.PING=1]="PING",e[e.PONG=2]="PONG",e[e.ACCEPT=3]="ACCEPT",e[e.CHALLENGE=4]="CHALLENGE",e[e.CHALLENGE_RESPONSE=5]="CHALLENGE_RESPONSE",e[e.REJECT=6]="REJECT",e[e.REDIRECT=7]="REDIRECT",e[e.CLOSING=8]="CLOSING",e[e.CLOSED=9]="CLOSED",e[e.AUTHENTICATION_TIMEOUT=80]="AUTHENTICATION_TIMEOUT",e[e.INVALID_MESSAGE=82]="INVALID_MESSAGE"}(a=t.CONNECTION_ACTIONS||(t.CONNECTION_ACTIONS={}));var c;!function(e){e[e.ERROR=0]="ERROR",e[e.REQUEST=1]="REQUEST",e[e.AUTH_SUCCESSFUL=2]="AUTH_SUCCESSFUL",e[e.AUTH_UNSUCCESSFUL=3]="AUTH_UNSUCCESSFUL",e[e.TOO_MANY_AUTH_ATTEMPTS=80]="TOO_MANY_AUTH_ATTEMPTS",e[e.INVALID_MESSAGE=82]="INVALID_MESSAGE",e[e.MESSAGE_PERMISSION_ERROR=96]="MESSAGE_PERMISSION_ERROR",e[e.MESSAGE_DENIED=97]="MESSAGE_DENIED",e[e.INVALID_MESSAGE_DATA=98]="INVALID_MESSAGE_DATA"}(c=t.AUTH_ACTIONS||(t.AUTH_ACTIONS={}));var E;!function(e){e[e.ERROR=0]="ERROR",e[e.EMIT=1]="EMIT",e[e.SUBSCRIBE=2]="SUBSCRIBE",e[e.SUBSCRIBE_ACK=130]="SUBSCRIBE_ACK",e[e.UNSUBSCRIBE=3]="UNSUBSCRIBE",e[e.UNSUBSCRIBE_ACK=131]="UNSUBSCRIBE_ACK",e[e.LISTEN=4]="LISTEN",e[e.LISTEN_ACK=132]="LISTEN_ACK",e[e.UNLISTEN=5]="UNLISTEN",e[e.UNLISTEN_ACK=133]="UNLISTEN_ACK",e[e.LISTEN_ACCEPT=6]="LISTEN_ACCEPT",e[e.LISTEN_REJECT=7]="LISTEN_REJECT",e[e.SUBSCRIPTION_FOR_PATTERN_FOUND=8]="SUBSCRIPTION_FOR_PATTERN_FOUND",e[e.SUBSCRIPTION_FOR_PATTERN_REMOVED=9]="SUBSCRIPTION_FOR_PATTERN_REMOVED",e[e.MESSAGE_PERMISSION_ERROR=96]="MESSAGE_PERMISSION_ERROR",e[e.MESSAGE_DENIED=97]="MESSAGE_DENIED",e[e.INVALID_MESSAGE_DATA=98]="INVALID_MESSAGE_DATA",e[e.MULTIPLE_SUBSCRIPTIONS=99]="MULTIPLE_SUBSCRIPTIONS",e[e.NOT_SUBSCRIBED=100]="NOT_SUBSCRIBED"}(E=t.EVENT_ACTIONS||(t.EVENT_ACTIONS={}));var u;!function(e){e[e.ERROR=0]="ERROR",e[e.READ=1]="READ",e[e.READ_RESPONSE=2]="READ_RESPONSE",e[e.HEAD=3]="HEAD",e[e.HEAD_RESPONSE=4]="HEAD_RESPONSE",e[e.DELETE=5]="DELETE",e[e.DELETE_SUCCESS=6]="DELETE_SUCCESS",e[e.DELETED=8]="DELETED",e[e.WRITE_ACKNOWLEDGEMENT=9]="WRITE_ACKNOWLEDGEMENT",e[e.CREATE=16]="CREATE",e[e.CREATEANDUPDATE=17]="CREATEANDUPDATE",e[e.CREATEANDUPDATE_WITH_WRITE_ACK=18]="CREATEANDUPDATE_WITH_WRITE_ACK",e[e.CREATEANDPATCH=19]="CREATEANDPATCH",e[e.CREATEANDPATCH_WITH_WRITE_ACK=20]="CREATEANDPATCH_WITH_WRITE_ACK",e[e.UPDATE=21]="UPDATE",e[e.UPDATE_WITH_WRITE_ACK=22]="UPDATE_WITH_WRITE_ACK",e[e.PATCH=23]="PATCH",e[e.PATCH_WITH_WRITE_ACK=24]="PATCH_WITH_WRITE_ACK",e[e.ERASE=25]="ERASE",e[e.ERASE_WITH_WRITE_ACK=26]="ERASE_WITH_WRITE_ACK",e[e.SUBSCRIBEANDHEAD=32]="SUBSCRIBEANDHEAD",e[e.SUBSCRIBEANDREAD=34]="SUBSCRIBEANDREAD",e[e.SUBSCRIBECREATEANDREAD=36]="SUBSCRIBECREATEANDREAD",e[e.SUBSCRIBECREATEANDUPDATE=38]="SUBSCRIBECREATEANDUPDATE",e[e.SUBSCRIBE=40]="SUBSCRIBE",e[e.SUBSCRIBE_ACK=168]="SUBSCRIBE_ACK",e[e.UNSUBSCRIBE=41]="UNSUBSCRIBE",e[e.UNSUBSCRIBE_ACK=169]="UNSUBSCRIBE_ACK",e[e.LISTEN=48]="LISTEN",e[e.LISTEN_ACK=176]="LISTEN_ACK",e[e.UNLISTEN=49]="UNLISTEN",e[e.UNLISTEN_ACK=177]="UNLISTEN_ACK",e[e.LISTEN_ACCEPT=50]="LISTEN_ACCEPT",e[e.LISTEN_REJECT=51]="LISTEN_REJECT",e[e.SUBSCRIPTION_HAS_PROVIDER=52]="SUBSCRIPTION_HAS_PROVIDER",e[e.SUBSCRIPTION_HAS_NO_PROVIDER=53]="SUBSCRIPTION_HAS_NO_PROVIDER",e[e.SUBSCRIPTION_FOR_PATTERN_FOUND=54]="SUBSCRIPTION_FOR_PATTERN_FOUND",e[e.SUBSCRIPTION_FOR_PATTERN_REMOVED=55]="SUBSCRIPTION_FOR_PATTERN_REMOVED",e[e.CACHE_RETRIEVAL_TIMEOUT=80]="CACHE_RETRIEVAL_TIMEOUT",e[e.STORAGE_RETRIEVAL_TIMEOUT=81]="STORAGE_RETRIEVAL_TIMEOUT",e[e.VERSION_EXISTS=82]="VERSION_EXISTS",e[e.RECORD_LOAD_ERROR=83]="RECORD_LOAD_ERROR",e[e.RECORD_CREATE_ERROR=84]="RECORD_CREATE_ERROR",e[e.RECORD_UPDATE_ERROR=85]="RECORD_UPDATE_ERROR",e[e.RECORD_DELETE_ERROR=86]="RECORD_DELETE_ERROR",e[e.RECORD_READ_ERROR=87]="RECORD_READ_ERROR",e[e.RECORD_NOT_FOUND=88]="RECORD_NOT_FOUND",e[e.INVALID_VERSION=89]="INVALID_VERSION",e[e.INVALID_PATCH_ON_HOTPATH=90]="INVALID_PATCH_ON_HOTPATH",e[e.MESSAGE_PERMISSION_ERROR=96]="MESSAGE_PERMISSION_ERROR",e[e.MESSAGE_DENIED=97]="MESSAGE_DENIED",e[e.INVALID_MESSAGE_DATA=98]="INVALID_MESSAGE_DATA",e[e.MULTIPLE_SUBSCRIPTIONS=99]="MULTIPLE_SUBSCRIPTIONS",e[e.NOT_SUBSCRIBED=100]="NOT_SUBSCRIBED",e[e.HAS=112]="HAS",e[e.HAS_RESPONSE=113]="HAS_RESPONSE"}(u=t.RECORD_ACTIONS||(t.RECORD_ACTIONS={}));var h;!function(e){e[e.ERROR=0]="ERROR",e[e.REQUEST=1]="REQUEST",e[e.ACCEPT=2]="ACCEPT",e[e.RESPONSE=3]="RESPONSE",e[e.REJECT=4]="REJECT",e[e.REQUEST_ERROR=5]="REQUEST_ERROR",e[e.PROVIDE=6]="PROVIDE",e[e.PROVIDE_ACK=134]="PROVIDE_ACK",e[e.UNPROVIDE=7]="UNPROVIDE",e[e.UNPROVIDE_ACK=135]="UNPROVIDE_ACK",e[e.NO_RPC_PROVIDER=80]="NO_RPC_PROVIDER",e[e.ACCEPT_TIMEOUT=82]="ACCEPT_TIMEOUT",e[e.MULTIPLE_ACCEPT=83]="MULTIPLE_ACCEPT",e[e.INVALID_RPC_CORRELATION_ID=84]="INVALID_RPC_CORRELATION_ID",e[e.RESPONSE_TIMEOUT=85]="RESPONSE_TIMEOUT",e[e.MULTIPLE_RESPONSE=86]="MULTIPLE_RESPONSE",e[e.MESSAGE_PERMISSION_ERROR=96]="MESSAGE_PERMISSION_ERROR",e[e.MESSAGE_DENIED=97]="MESSAGE_DENIED",e[e.INVALID_MESSAGE_DATA=98]="INVALID_MESSAGE_DATA",e[e.MULTIPLE_PROVIDERS=99]="MULTIPLE_PROVIDERS",e[e.NOT_PROVIDED=100]="NOT_PROVIDED"}(h=t.RPC_ACTIONS||(t.RPC_ACTIONS={}));var l;!function(e){e[e.ERROR=0]="ERROR",e[e.QUERY_ALL=1]="QUERY_ALL",e[e.QUERY_ALL_RESPONSE=2]="QUERY_ALL_RESPONSE",e[e.QUERY=3]="QUERY",e[e.QUERY_RESPONSE=4]="QUERY_RESPONSE",e[e.PRESENCE_JOIN=5]="PRESENCE_JOIN",e[e.PRESENCE_JOIN_ALL=6]="PRESENCE_JOIN_ALL",e[e.PRESENCE_LEAVE=7]="PRESENCE_LEAVE",e[e.PRESENCE_LEAVE_ALL=8]="PRESENCE_LEAVE_ALL",e[e.SUBSCRIBE=9]="SUBSCRIBE",e[e.SUBSCRIBE_ACK=137]="SUBSCRIBE_ACK",e[e.UNSUBSCRIBE=10]="UNSUBSCRIBE",e[e.UNSUBSCRIBE_ACK=138]="UNSUBSCRIBE_ACK",e[e.SUBSCRIBE_ALL=11]="SUBSCRIBE_ALL",e[e.SUBSCRIBE_ALL_ACK=139]="SUBSCRIBE_ALL_ACK",e[e.UNSUBSCRIBE_ALL=12]="UNSUBSCRIBE_ALL",e[e.UNSUBSCRIBE_ALL_ACK=140]="UNSUBSCRIBE_ALL_ACK",e[e.INVALID_PRESENCE_USERS=80]="INVALID_PRESENCE_USERS",e[e.MESSAGE_PERMISSION_ERROR=96]="MESSAGE_PERMISSION_ERROR",e[e.MESSAGE_DENIED=97]="MESSAGE_DENIED",e[e.INVALID_MESSAGE_DATA=98]="INVALID_MESSAGE_DATA",e[e.MULTIPLE_SUBSCRIPTIONS=99]="MULTIPLE_SUBSCRIPTIONS",e[e.NOT_SUBSCRIBED=100]="NOT_SUBSCRIBED"}(l=t.PRESENCE_ACTIONS||(t.PRESENCE_ACTIONS={})),t.ACTIONS=(r={},i(r,o.PARSER,s),i(r,o.CONNECTION,a),i(r,o.AUTH,c),i(r,o.EVENT,E),i(r,o.RECORD,u),i(r,o.RPC,h),i(r,o.PRESENCE,l),r);!function(e){e.INFO="INFO",e.DEPRECATED="DEPRECATED",e.INCOMING_CONNECTION="INCOMING_CONNECTION",e.CLOSED_SOCKET_INTERACTION="CLOSED_SOCKET_INTERACTION",e.CLIENT_DISCONNECTED="CLIENT_DISCONNECTED",e.CONNECTION_ERROR="CONNECTION_ERROR",e.AUTH_ERROR="AUTH_ERROR",e.PLUGIN_ERROR="PLUGIN_ERROR",e.PLUGIN_INITIALIZATION_ERROR="PLUGIN_INITIALIZATION_ERROR",e.PLUGIN_INITIALIZATION_TIMEOUT="PLUGIN_INITIALIZATION_TIMEOUT",e.TIMEOUT="TIMEOUT",e.LEADING_LISTEN="LEADING_LISTEN",e.LOCAL_LISTEN="LOCAL_LISTEN",e.INVALID_CONFIG_DATA="INVALID_CONFIG_DATA",e.INVALID_STATE_TRANSITION="INVALID_STATE_TRANSITION"}(t.EVENT||(t.EVENT={}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});!function(e){e[e.UNSOLICITED_MESSAGE=0]="UNSOLICITED_MESSAGE",e[e.IS_CLOSED=1]="IS_CLOSED",e[e.MAX_RECONNECTION_ATTEMPTS_REACHED=2]="MAX_RECONNECTION_ATTEMPTS_REACHED",e[e.CONNECTION_ERROR=3]="CONNECTION_ERROR",e[e.ACK_TIMEOUT=4]="ACK_TIMEOUT",e[e.UNKNOWN_CORRELATION_ID=5]="UNKNOWN_CORRELATION_ID",e[e.HEARTBEAT_TIMEOUT=6]="HEARTBEAT_TIMEOUT",e[e.LISTENER_EXISTS=7]="LISTENER_EXISTS",e[e.NOT_LISTENING=8]="NOT_LISTENING",e[e.RECORD_ALREADY_DESTROYED=9]="RECORD_ALREADY_DESTROYED",e[e.RECORD_DELETE_TIMEOUT=10]="RECORD_DELETE_TIMEOUT",e.CLIENT_OFFLINE="client offline",e.INVALID_AUTHENTICATION_DETAILS="INVALID_AUTHENTICATION_DETAILS",e.CONNECTION_LOST="connectionLost",e.CONNECTION_REESTABLISHED="connectionReestablished",e.CONNECTION_STATE_CHANGED="connectionStateChanged",e.AUTHENTICATION_TIMEOUT="AUTHENTICATION_TIMEOUT",e.RECORD_ERROR="error",e.RECORD_READY="ready",e.RECORD_DELETED="delete",e.RECORD_DISCARDED="discard",e.RECORD_VERSION_EXISTS="versionExists",e.RECORD_HAS_PROVIDER_CHANGED="hasProviderChanged",e.RECORD_STATE_CHANGED="onRecordStateChanged",e.ENTRY_ADDED_EVENT="entry-added",e.ENTRY_REMOVED_EVENT="entry-removed",e.ENTRY_MOVED_EVENT="entry-moved"}(t.EVENT||(t.EVENT={}));!function(e){e.CLOSING="CLOSING",e.CLOSED="CLOSED",e.AWAITING_CONNECTION="AWAITING_CONNECTION",e.CHALLENGING="CHALLENGING",e.AWAITING_AUTHENTICATION="AWAITING_AUTHENTICATION",e.AUTHENTICATING="AUTHENTICATING",e.OPEN="OPEN",e.ERROR="ERROR",e.RECONNECTING="RECONNECTING",e.REDIRECTING="REDIRECTING",e.CHALLENGE_DENIED="CHALLENGE_DENIED",e.TOO_MANY_AUTH_ATTEMPTS="TOO_MANY_AUTH_ATTEMPTS",e.AUTHENTICATION_TIMEOUT="AUTHENTICATION_TIMEOUT"}(t.CONNECTION_STATE||(t.CONNECTION_STATE={}))},function(e,t,n){function i(e){if(e)return function(e){for(var t in i.prototype)e[t]=i.prototype[t];return e}(e)}e.exports=i,i.prototype.on=i.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||Object.create(null),(this._callbacks[e]=this._callbacks[e]||[]).push(t),this},i.prototype.once=function(e,t){function n(){this.off(e,n),t.apply(this,arguments)}return n.fn=t,this.on(e,n),this},i.prototype.off=i.prototype.removeListener=i.prototype.removeAllListeners=i.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||Object.create(null),0==arguments.length)return this._callbacks=Object.create(null),this;var n=this._callbacks[e];if(!n)return this;if(1==arguments.length)return delete this._callbacks[e],this;for(var i,r=0;r<n.length;r++)if((i=n[r])===t||i.fn===t){n.splice(r,1);break}return 0===n.length&&delete this._callbacks[e],this},i.prototype.emit=function(e){this._callbacks=this._callbacks||Object.create(null);for(var t=new Array(arguments.length-1),n=this._callbacks[e],i=1;i<arguments.length;i++)t[i-1]=arguments[i];if(n)for(var i=0,r=(n=n.slice(0)).length;i<r;++i)n[i].apply(this,t);return this},i.prototype.listeners=function(e){return this._callbacks=this._callbacks||Object.create(null),this._callbacks[e]||[]},i.prototype.hasListeners=function(e){return!!this.listeners(e).length},i.prototype.eventNames=function(){return this._callbacks?Object.keys(this._callbacks):[]}},function(e,t,n){"use strict";var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(t,"__esModule",{value:!0});var r=n(17),o=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;t.trim=function(e){return e.trim?e.trim():e.replace(o,"")},t.deepEquals=function(e,t){return e===t||"object"===(void 0===e?"undefined":i(e))&&"object"===(void 0===t?"undefined":i(t))&&JSON.stringify(e)===JSON.stringify(t)},t.deepCopy=function(e){return"object"===(void 0===e?"undefined":i(e))?JSON.parse(JSON.stringify(e)):e},t.shallowCopy=function(e){if(Array.isArray(e))return e.slice(0);if("object"===(void 0===e?"undefined":i(e))){for(var t=Object.create(null),n=Object.keys(e),r=0;r<n.length;r++)t[n[r]]=e[n[r]];return t}return e};var s=/^wss:|^ws:|^\/\//,a=/^http:|^https:/;t.parseUrl=function(e,t){var n=e;if(a.test(n))throw new Error("Only ws and wss are supported");s.test(n)?0===n.indexOf("//")&&(n="ws:"+n):n="ws://"+n;var i=r.parse(n);if(!i.host)throw new Error("invalid url, missing host");return i.protocol=i.protocol?i.protocol:"ws:",i.pathname=i.pathname?i.pathname:t,r.format(i)},t.getUid=function(){return(new Date).getTime().toString(36)+"-"+(1e16*Math.random()).toString(36).replace(".","")},t.normalizeSetArguments=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=void 0,r=function(e){return void 0!==e&&"object"===(void 0===e?"undefined":i(e))},o=function(e){return"function"!=typeof e},s=function(e){return void 0!==e&&"string"==typeof e},a=function(e){return"function"==typeof e};if(e.length===t+1&&(n={path:void 0,data:r(e[t])?e[t]:void 0,callback:void 0}),e.length===t+2&&(n={path:void 0,data:void 0,callback:void 0},!a(e[t+1])&&o(e[t+1])&&(n.path=!!s(e[t])&&e[t]),s(e[t])?n.data=o(e[t+1])?e[t+1]:void 0:n.data=r(e[t])?e[t]:void 0,s(e[t])||(n.callback=!!a(e[t+1])&&e[t+1])),e.length===t+3&&(n={path:!!s(e[t])&&e[t],data:o(e[t+1])?e[t+1]:void 0,callback:!!a(e[t+2])&&e[t+2]}),n){if(void 0!==n.path&&0===n.path.length||!1===n.path)throw Error("Invalid set path argument");if(void 0===n.data&&!n.path)throw Error("Invalid set data argument");if(void 0!==n.callback&&!1===n.callback)throw Error("Invalid set callback argument");return n}throw Error("Invalid set arguments")},t.normalizeArguments=function(e){if(1===e.length&&"object"===i(e[0]))return e[0];for(var t=Object.create(null),n=0;n<e.length;n++)"string"==typeof e[n]?t.path=e[n]:"function"==typeof e[n]?t.callback=e[n]:"boolean"==typeof e[n]&&(t.triggerNow=e[n]);return t}},function(e,t,n){"use strict";var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(11),o=n(1);t.EVENT=o.EVENT,t.CONNECTION_STATE=o.CONNECTION_STATE;var s=n(0);t.C=s;var a=n(13),c=n(14),E=n(15),u=n(16),h=n(25),l=n(27),T=n(28),C=n(31),R=n(38),N=n(2),O=function(e){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var i=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));i.options=Object.assign({},r.DefaultOptions,n);var o={};return o.logger=new a.Logger(i),o.timerRegistry=new E.TimerRegistry,o.timeoutRegistry=new c.TimeoutRegistry(o,i.options),o.socketFactory=n.socketFactory||h.socketFactory,o.connection=new u.Connection(o,i.options,e,i),i.services=o,i.services.timeoutRegistry.onConnectionLost=o.connection.onLost.bind(i),i.event=new l.EventHandler(i.services,i.options),i.rpc=new T.RPCHandler(i.services,i.options),i.record=new C.RecordHandler(i.services,i.options),i.presence=new R.PresenceHandler(i.services,i.options),i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,N),i(t,[{key:"login",value:function(e,t){this.services.connection.authenticate(e,t)}},{key:"getConnectionState",value:function(){return this.services.connection.getConnectionState()}},{key:"close",value:function(){this.services.connection.close()}},{key:"getUid",value:function(){return(new Date).getTime().toString(36)+"-"+(1e16*Math.random()).toString(36).replace(".","")}}]),t}();t.Client=O,t.deepstream=function(e,t){return new O(e,t)}},function(e,t,n){"use strict";(function(e){function i(e){return e.action>=80&&e.action<112||e.topic===a.TOPIC.PARSER}function r(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=0,u=[];do{var h=function(e,t){if(e.length<t+c.HEADER_LENGTH)return{bytesConsumed:0};var n=!!(128&e[t]),i=127&e[t],r=e[t+1],o=e.readUIntBE(t+2,3),s=e.readUIntBE(t+5,3),a=c.HEADER_LENGTH+o+s;if(e.length<t+a)return{bytesConsumed:0};var E=e.slice(t,t+c.HEADER_LENGTH),u={fin:n,topic:i,action:r,rawHeader:E};o>0&&(u.meta=e.slice(t+c.HEADER_LENGTH,t+c.HEADER_LENGTH+o));s>0&&(u.payload=e.slice(t+c.HEADER_LENGTH+o,t+a));return{bytesConsumed:a,rawMessage:u}}(t,r),l=h.bytesConsumed,T=h.rawMessage;if(!T)break;if(n.push(T),r+=l,T.fin){var C=function(e){var t=e.topic,n=e.action,r=e.rawHeader;if(void 0===a.TOPIC[t])return{parseError:!0,action:a.PARSER_ACTIONS.UNKNOWN_TOPIC,parsedMessage:{topic:t,action:n},description:"unknown topic "+t,raw:r};var u=t;if(void 0===a.ACTIONS[u][n])return{parseError:!0,action:a.PARSER_ACTIONS.UNKNOWN_ACTION,parsedMessage:{topic:u,action:n},description:"unknown "+a.TOPIC[u]+" action "+n,raw:r};var h={topic:u,action:127&n};if(e.meta&&e.meta.length>0){var l=o(e.meta);if(!l||"object"!==(void 0===l?"undefined":s(l)))return{parseError:!0,action:a.PARSER_ACTIONS.MESSAGE_PARSE_ERROR,parsedMessage:h,description:"invalid meta field "+e.meta.toString(),raw:r};!function(e,t){for(var n in a.META_KEYS){var i=e[a.META_KEYS[n]];void 0!==i&&(t[n]=i)}}(l,h)}if(void 0!==e.payload){if(!E.hasPayload(h.topic,n))return{parseError:!0,action:a.PARSER_ACTIONS.INVALID_MESSAGE,parsedMessage:h,description:"should not have a payload"};h.payloadEncoding||u!==a.TOPIC.PARSER||(h.payloadEncoding=a.PAYLOAD_ENCODING.BINARY),h.data=e.payload}h.isAck=n>=128,h.isError=i(h),h.topic===a.TOPIC.RECORD&&n>=16&&n<32&&(h.isWriteAck=c.isWriteAck(h.action));var T=E.validate(h);if(T)return console.trace("invalid message",h),{parseError:!0,action:a.PARSER_ACTIONS.INVALID_META_PARAMS,parsedMessage:h,description:T};return h}(function(t){if(0===t.length)throw new Error("parseMessage must not be called with an empty message queue");if(1===t.length)return t[0];var n=t[0],i=n.topic,r=n.action,o=n.rawHeader,s=[],a=[];t.forEach(function(e){var t=e.payload,n=e.meta;t&&s.push(t),n&&a.push(n)});var c=e.concat(s),E=e.concat(a);return{fin:!0,topic:i,action:r,rawHeader:o,meta:E,payload:c}}(n));n.length=0,u.push(C)}}while(r<t.length);return u}function o(e){try{return JSON.parse(e.toString())}catch(e){return}}var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(t,"__esModule",{value:!0});var a=n(0),c=n(6),E=n(7);t.isError=i,t.parse=r,t.parseData=function(e){return void 0!==e.parsedData||void 0===e.data||(e.payloadEncoding&&e.payloadEncoding!==a.PAYLOAD_ENCODING.JSON?new Error("unable to parse data of type '"+e.payloadEncoding+"'"):"string"==typeof e.data?new Error("tried to parse string data with binary parser"):(e.parsedData=o(e.data),void 0!==e.parsedData||new Error("unable to parse data "+e.data)))},t.parseJSON=o}).call(t,n(!function(){var e=new Error('Cannot find module "./../../node_modules/node-libs-browser/node_modules/buffer/index.js"');throw e.code="MODULE_NOT_FOUND",e}()).Buffer)},function(e,t,n){"use strict";function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var r;Object.defineProperty(t,"__esModule",{value:!0});var o=n(0);t.HEADER_LENGTH=8,t.META_PAYLOAD_OVERFLOW_LENGTH=Math.pow(2,24)-1,t.isWriteAck=function(e){return e===o.RECORD_ACTIONS.CREATEANDPATCH_WITH_WRITE_ACK||e===o.RECORD_ACTIONS.CREATEANDUPDATE_WITH_WRITE_ACK||e===o.RECORD_ACTIONS.PATCH_WITH_WRITE_ACK||e===o.RECORD_ACTIONS.UPDATE_WITH_WRITE_ACK||e===o.RECORD_ACTIONS.ERASE_WITH_WRITE_ACK},t.actionToWriteAck=(r={},i(r,o.RECORD_ACTIONS.CREATEANDPATCH,o.RECORD_ACTIONS.CREATEANDPATCH_WITH_WRITE_ACK),i(r,o.RECORD_ACTIONS.CREATEANDUPDATE,o.RECORD_ACTIONS.CREATEANDUPDATE_WITH_WRITE_ACK),i(r,o.RECORD_ACTIONS.PATCH,o.RECORD_ACTIONS.PATCH_WITH_WRITE_ACK),i(r,o.RECORD_ACTIONS.UPDATE,o.RECORD_ACTIONS.UPDATE_WITH_WRITE_ACK),i(r,o.RECORD_ACTIONS.ERASE,o.RECORD_ACTIONS.ERASE_WITH_WRITE_ACK),r)},function(e,t,n){"use strict";function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t,n){var i=e[t];return!!i&&-1!==i.indexOf(n)}var o,s,a;Object.defineProperty(t,"__esModule",{value:!0});var c=n(0),E=(o={},i(o,c.TOPIC.PARSER,[c.PARSER_ACTIONS.MESSAGE_PARSE_ERROR,c.PARSER_ACTIONS.INVALID_META_PARAMS]),i(o,c.TOPIC.AUTH,[c.AUTH_ACTIONS.REQUEST,c.AUTH_ACTIONS.AUTH_SUCCESSFUL,c.AUTH_ACTIONS.AUTH_UNSUCCESSFUL]),i(o,c.TOPIC.RECORD,[c.RECORD_ACTIONS.READ_RESPONSE,c.RECORD_ACTIONS.UPDATE,c.RECORD_ACTIONS.UPDATE_WITH_WRITE_ACK,c.RECORD_ACTIONS.PATCH,c.RECORD_ACTIONS.PATCH_WITH_WRITE_ACK,c.RECORD_ACTIONS.CREATEANDUPDATE,c.RECORD_ACTIONS.CREATEANDUPDATE_WITH_WRITE_ACK,c.RECORD_ACTIONS.CREATEANDPATCH,c.RECORD_ACTIONS.CREATEANDPATCH_WITH_WRITE_ACK,c.RECORD_ACTIONS.WRITE_ACKNOWLEDGEMENT,c.RECORD_ACTIONS.VERSION_EXISTS]),i(o,c.TOPIC.RPC,[c.RPC_ACTIONS.REQUEST,c.RPC_ACTIONS.RESPONSE]),i(o,c.TOPIC.EVENT,[c.EVENT_ACTIONS.EMIT]),i(o,c.TOPIC.PRESENCE,[c.PRESENCE_ACTIONS.SUBSCRIBE,c.PRESENCE_ACTIONS.UNSUBSCRIBE,c.PRESENCE_ACTIONS.QUERY,c.PRESENCE_ACTIONS.QUERY_RESPONSE,c.PRESENCE_ACTIONS.QUERY_ALL_RESPONSE]),o),u=(s={},i(s,c.TOPIC.RPC,[c.RPC_ACTIONS.REQUEST,c.RPC_ACTIONS.REQUEST_ERROR,c.RPC_ACTIONS.ACCEPT,c.RPC_ACTIONS.REJECT,c.RPC_ACTIONS.RESPONSE,c.RPC_ACTIONS.MULTIPLE_RESPONSE,c.RPC_ACTIONS.RESPONSE_TIMEOUT,c.RPC_ACTIONS.INVALID_RPC_CORRELATION_ID,c.RPC_ACTIONS.MULTIPLE_ACCEPT,c.RPC_ACTIONS.ACCEPT_TIMEOUT,c.RPC_ACTIONS.NO_RPC_PROVIDER,c.RPC_ACTIONS.MESSAGE_PERMISSION_ERROR,c.RPC_ACTIONS.MESSAGE_DENIED,c.RPC_ACTIONS.INVALID_MESSAGE_DATA,c.RPC_ACTIONS.MULTIPLE_PROVIDERS,c.RPC_ACTIONS.NOT_PROVIDED]),i(s,c.TOPIC.PRESENCE,[c.PRESENCE_ACTIONS.QUERY,c.PRESENCE_ACTIONS.QUERY_RESPONSE,c.PRESENCE_ACTIONS.SUBSCRIBE,c.PRESENCE_ACTIONS.SUBSCRIBE_ACK,c.PRESENCE_ACTIONS.UNSUBSCRIBE,c.PRESENCE_ACTIONS.UNSUBSCRIBE_ACK]),s),h=(a={},i(a,c.TOPIC.EVENT,[c.EVENT_ACTIONS.SUBSCRIBE,c.EVENT_ACTIONS.UNSUBSCRIBE,c.EVENT_ACTIONS.LISTEN,c.EVENT_ACTIONS.UNLISTEN]),i(a,c.TOPIC.RECORD,[c.RECORD_ACTIONS.SUBSCRIBE,c.RECORD_ACTIONS.UNSUBSCRIBE,c.RECORD_ACTIONS.LISTEN,c.RECORD_ACTIONS.UNLISTEN,c.RECORD_ACTIONS.DELETE]),i(a,c.TOPIC.PRESENCE,[c.PRESENCE_ACTIONS.SUBSCRIBE,c.PRESENCE_ACTIONS.UNSUBSCRIBE,c.PRESENCE_ACTIONS.SUBSCRIBE_ALL,c.PRESENCE_ACTIONS.UNSUBSCRIBE_ALL]),i(a,c.TOPIC.RPC,[c.RPC_ACTIONS.PROVIDE,c.RPC_ACTIONS.UNPROVIDE]),a);t.hasCorrelationId=function(e,t){return r(u,e,t)},t.hasAck=function(e,t){return r(h,e,t)},t.hasPayload=function(e,t){return r(E,e,t)},t.validate=function(e){var n=e.action;if(e.isAck){if(!t.hasAck(e.topic,e.action))return"should not have an ack";n=e.action+128}if(!(n>=96&&n<112)){var i=t.hasCorrelationId(e.topic,n);return!!e.correlationId!==i?"should "+(i?"":"not ")+"have a correlationId":void 0}}},function(e,t,n){"use strict";var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.inEndState=!1,this.logger=t,this.transitions=n.transitions,this.state=n.init,this.stateMachine=n}return i(e,[{key:"transition",value:function(e){for(var t=void 0,n=0;n<this.transitions.length;n++)if(t=this.transitions[n],e===t.name&&(this.state===t.from||void 0===t.from)){var i=this.state;return this.state=t.to,this.stateMachine.onStateChanged&&this.stateMachine.onStateChanged(this.state,i),void(t.handler&&t.handler())}var r=JSON.stringify({transition:e,state:this.state});throw new Error("Invalid state transition: "+r)}}]),e}();t.StateMachine=r},function(e,t,n){"use strict";var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),o=n(1),s=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.topic=t,this.services=n,this.listeners=new Map,this.stopCallbacks=new Map,t===r.TOPIC.RECORD?this.actions=r.RECORD_ACTIONS:t===r.TOPIC.EVENT&&(this.actions=r.EVENT_ACTIONS),this.services.connection.onLost(this.onConnectionLost.bind(this)),this.services.connection.onReestablished(this.onConnectionReestablished.bind(this))}return i(e,[{key:"listen",value:function(e,t){if("string"!=typeof e||0===e.length)throw new Error("invalid argument pattern");if("function"!=typeof t)throw new Error("invalid argument callback");this.listeners.has(e)?this.services.logger.warn({topic:this.topic,action:o.EVENT.LISTENER_EXISTS,name:e}):(this.listeners.set(e,t),this.sendListen(e))}},{key:"unlisten",value:function(e){if("string"!=typeof e||0===e.length)throw new Error("invalid argument pattern");this.listeners.has(e)?(this.listeners.delete(e),this.sendUnlisten(e)):this.services.logger.warn({topic:this.topic,action:o.EVENT.NOT_LISTENING,name:e})}},{key:"accept",value:function(e,t){this.services.connection.sendMessage({topic:this.topic,action:this.actions.LISTEN_ACCEPT,name:e,subscription:t})}},{key:"reject",value:function(e,t){this.services.connection.sendMessage({topic:this.topic,action:this.actions.LISTEN_REJECT,name:e,subscription:t})}},{key:"stop",value:function(e,t){this.stopCallbacks.set(e,t)}},{key:"handle",value:function(e){if(e.action!==this.actions.SUBSCRIPTION_FOR_PATTERN_FOUND)if(e.action!==this.actions.SUBSCRIPTION_FOR_PATTERN_REMOVED)this.services.logger.error(e,o.EVENT.UNSOLICITED_MESSAGE);else{var t=this.stopCallbacks.get(e.subscription);t&&(t(e.subscription),this.stopCallbacks.delete(e.subscription))}else{var n=this.listeners.get(e.name);n&&n(e.subscription,{accept:this.accept.bind(this,e.name,e.subscription),reject:this.reject.bind(this,e.name,e.subscription),onStop:this.stop.bind(this,e.subscription)})}}},{key:"onConnectionLost",value:function(){this.stopCallbacks.forEach(function(e,t){e(t)}),this.stopCallbacks.clear()}},{key:"onConnectionReestablished",value:function(){var e=this;this.listeners.forEach(function(t,n){e.sendListen(n)})}},{key:"sendListen",value:function(e){var t={topic:this.topic,action:this.actions.LISTEN,name:e};this.services.timeoutRegistry.add({message:t}),this.services.connection.sendMessage(t)}},{key:"sendUnlisten",value:function(e){var t={topic:this.topic,action:this.actions.UNLISTEN,name:e};this.services.timeoutRegistry.add({message:t}),this.services.connection.sendMessage(t)}}]),e}();t.Listener=s},function(e,t,n){e.exports=n(4)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(12);t.DefaultOptions={heartbeatInterval:3e4,reconnectIntervalIncrement:4e3,maxReconnectInterval:18e4,maxReconnectAttempts:5,rpcAcceptTimeout:6e3,rpcResponseTimeout:1e4,subscriptionTimeout:2e3,recordReadAckTimeout:15e3,recordReadTimeout:15e3,recordDeleteTimeout:15e3,discardTimeout:5e3,path:"/deepstream",mergeStrategy:i.REMOTE_WINS,recordDeepCopy:!0,socketOptions:null}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.REMOTE_WINS=function(e,t,n,i){i(null,t)},t.LOCAL_WINS=function(e,t,n,i){i(null,e.get())}},function(e,t,n){"use strict";var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),o=n(0),s=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.emitter=t}return i(e,[{key:"warn",value:function(e,t,n){console.warn("warn",e,t,n)}},{key:"error",value:function(e,t,n){if(function(e){return void 0!==r.EVENT[e]}(t))t===r.EVENT.IS_CLOSED?this.emitter.emit("error",n,r.EVENT[t],o.TOPIC[o.TOPIC.CONNECTION]):t===r.EVENT.CONNECTION_ERROR&&this.emitter.emit("error",n,r.EVENT[t],o.TOPIC[o.TOPIC.CONNECTION]);else{var i=t||e.action;this.emitter.emit("error",n,o.ACTIONS[e.topic][i],o.TOPIC[e.topic])}}}]),e}();t.Logger=s},function(e,t,n){"use strict";var i=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],i=!0,r=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(i=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);i=!0);}catch(e){r=!0,o=e}finally{try{!i&&a.return&&a.return()}finally{if(r)throw o}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(1),s=n(2),a=function(e){function t(e,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var i=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.options=n,i.services=e,i.register=new Map,i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,s),r(t,[{key:"add",value:function(e){if(void 0===e.duration&&(e.duration=this.options.subscriptionTimeout),void 0===e.event&&(e.event=o.EVENT.ACK_TIMEOUT),!this.services.connection.isConnected)return-1;this.remove(e.message);var t=Object.assign({},{timerId:-1,uniqueName:this.getUniqueName(e.message),event:e.event},{timeout:e});return t.timerId=this.services.timerRegistry.add({context:this,callback:this.onTimeout,duration:e.duration,data:t}),this.register.set(t.timerId,t),t.timerId}},{key:"remove",value:function(e){var t=this.getUniqueName(e),n=!0,r=!1,o=void 0;try{for(var s,a=this.register[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var c=s.value,E=i(c,2),u=E[0];E[1].uniqueName===t&&(clearTimeout(u),this.register.delete(u))}}catch(e){r=!0,o=e}finally{try{!n&&a.return&&a.return()}finally{if(r)throw o}}}},{key:"clear",value:function(e){this.services.timerRegistry.remove(e),this.register.delete(e)}},{key:"onTimeout",value:function(e){this.register.delete(e.timerId);var t=e.timeout;t.callback?t.callback(t.event,t.message):this.services.logger.warn(t.message,t.event)}},{key:"getUniqueName",value:function(e){var t=e.originalAction||e.action,n=""+e.topic+t+"_";return e.correlationId?n+=e.correlationId:e.name&&(n+=e.name),n}},{key:"onConnectionLost",value:function(){var e=!0,t=!1,n=void 0;try{for(var r,o=this.register[Symbol.iterator]();!(e=(r=o.next()).done);e=!0){var s=r.value,a=i(s,2),c=(a[0],a[1]);clearTimeout(c.timerId),this.register.delete(c.timerId)}}catch(e){t=!0,n=e}finally{try{!e&&o.return&&o.return()}finally{if(t)throw n}}}}]),t}();t.TimeoutRegistry=a},function(e,t,n){"use strict";(function(e){var n=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function t(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t)}return n(t,[{key:"add",value:function(e){return setTimeout(e.callback.bind(e.context,e.data),e.duration)}},{key:"remove",value:function(e){return clearTimeout(e),!0}},{key:"requestIdleCallback",value:function(t){e.nextTick(t)}}]),t}();t.TimerRegistry=i}).call(t,n(!function(){var e=new Error('Cannot find module "./../../node_modules/process/browser.js"');throw e.code="MODULE_NOT_FOUND",e}()))},function(e,t,n){"use strict";var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(1),s=n(0),a=n(5),c=n(8),E=n(3),u=n(2),h=function(){function e(t,n,i,r){var s=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.options=n,this.services=t,this.authParams=null,this.handlers=new Map,this.isConnected=!1,this.authCallback=function(){},this.emitter=r,this.internalEmitter=new u;var a=!1,h=!0;this.stateMachine=new c.StateMachine(this.services.logger,{init:o.CONNECTION_STATE.CLOSED,onStateChanged:function(e,t){e!==t&&(s.isConnected=e===o.CONNECTION_STATE.OPEN,r.emit(o.EVENT.CONNECTION_STATE_CHANGED,e),e===o.CONNECTION_STATE.RECONNECTING?(a=!0,t!==o.CONNECTION_STATE.RECONNECTING&&s.internalEmitter.emit(o.EVENT.CONNECTION_LOST)):e===o.CONNECTION_STATE.OPEN&&(a||h)&&(h=!1,s.internalEmitter.emit(o.EVENT.CONNECTION_REESTABLISHED)))},transitions:[{name:"connected",from:o.CONNECTION_STATE.CLOSED,to:o.CONNECTION_STATE.AWAITING_CONNECTION},{name:"connected",from:o.CONNECTION_STATE.REDIRECTING,to:o.CONNECTION_STATE.AWAITING_CONNECTION},{name:"connected",from:o.CONNECTION_STATE.RECONNECTING,to:o.CONNECTION_STATE.AWAITING_CONNECTION},{name:"challenge",from:o.CONNECTION_STATE.AWAITING_CONNECTION,to:o.CONNECTION_STATE.CHALLENGING},{name:"redirected",from:o.CONNECTION_STATE.CHALLENGING,to:o.CONNECTION_STATE.REDIRECTING},{name:"challenge-denied",from:o.CONNECTION_STATE.CHALLENGING,to:o.CONNECTION_STATE.CHALLENGE_DENIED},{name:"accepted",from:o.CONNECTION_STATE.CHALLENGING,to:o.CONNECTION_STATE.AWAITING_AUTHENTICATION,handler:this.onAwaitingAuthentication.bind(this)},{name:"authentication-timeout",from:o.CONNECTION_STATE.AWAITING_CONNECTION,to:o.CONNECTION_STATE.AUTHENTICATION_TIMEOUT},{name:"authentication-timeout",from:o.CONNECTION_STATE.AWAITING_AUTHENTICATION,to:o.CONNECTION_STATE.AUTHENTICATION_TIMEOUT},{name:"authenticate",from:o.CONNECTION_STATE.AWAITING_AUTHENTICATION,to:o.CONNECTION_STATE.AUTHENTICATING},{name:"unsuccesful-login",from:o.CONNECTION_STATE.AUTHENTICATING,to:o.CONNECTION_STATE.AWAITING_AUTHENTICATION},{name:"succesful-login",from:o.CONNECTION_STATE.AUTHENTICATING,to:o.CONNECTION_STATE.OPEN},{name:"too-many-auth-attempts",from:o.CONNECTION_STATE.AUTHENTICATING,to:o.CONNECTION_STATE.TOO_MANY_AUTH_ATTEMPTS},{name:"too-many-auth-attempts",from:o.CONNECTION_STATE.AWAITING_AUTHENTICATION,to:o.CONNECTION_STATE.TOO_MANY_AUTH_ATTEMPTS},{name:"authentication-timeout",from:o.CONNECTION_STATE.AWAITING_AUTHENTICATION,to:o.CONNECTION_STATE.AUTHENTICATION_TIMEOUT},{name:"reconnect",from:o.CONNECTION_STATE.RECONNECTING,to:o.CONNECTION_STATE.RECONNECTING},{name:"closed",from:o.CONNECTION_STATE.CLOSING,to:o.CONNECTION_STATE.CLOSED},{name:"error",to:o.CONNECTION_STATE.RECONNECTING},{name:"connection-lost",to:o.CONNECTION_STATE.RECONNECTING},{name:"close",to:o.CONNECTION_STATE.CLOSING}]}),this.originalUrl=E.parseUrl(i,this.options.path),this.url=this.originalUrl,this.createEndpoint()}return r(e,[{key:"onLost",value:function(e){this.internalEmitter.on(o.EVENT.CONNECTION_LOST,e)}},{key:"onReestablished",value:function(e){this.internalEmitter.on(o.EVENT.CONNECTION_REESTABLISHED,e)}},{key:"registerHandler",value:function(e,t){this.handlers.set(e,t)}},{key:"sendMessage",value:function(e){this.endpoint.sendParsedMessage(e)}},{key:"authenticate",value:function(e,t){if("object"!==(void 0===e?"undefined":i(e)))throw new Error("invalid argument authParams");this.stateMachine.state!==o.CONNECTION_STATE.CHALLENGE_DENIED&&this.stateMachine.state!==o.CONNECTION_STATE.TOO_MANY_AUTH_ATTEMPTS&&this.stateMachine.state!==o.CONNECTION_STATE.AUTHENTICATION_TIMEOUT?(e&&(this.authParams=e),t&&(this.authCallback=t),this.stateMachine.state===o.CONNECTION_STATE.AWAITING_AUTHENTICATION&&this.authParams&&this.sendAuthParams()):this.services.logger.error({topic:s.TOPIC.CONNECTION},o.EVENT.IS_CLOSED)}},{key:"getConnectionState",value:function(){return this.stateMachine.state}},{key:"close",value:function(){this.services.timerRegistry.remove(this.heartbeatInterval),this.sendMessage({topic:s.TOPIC.CONNECTION,action:s.CONNECTION_ACTIONS.CLOSING}),this.stateMachine.transition("close")}},{key:"createEndpoint",value:function(){this.endpoint=this.services.socketFactory(this.url,this.options.socketOptions),this.endpoint.onopen=this.onOpen.bind(this),this.endpoint.onerror=this.onError.bind(this),this.endpoint.onclose=this.onClose.bind(this),this.endpoint.onparsedmessages=this.onMessages.bind(this)}},{key:"onOpen",value:function(){this.clearReconnect(),this.lastHeartBeat=Date.now(),this.checkHeartBeat(),this.stateMachine.transition("connected")}},{key:"onError",value:function(e){var t=this;setTimeout(function(){var n=void 0;if("ECONNRESET"===e.code||"ECONNREFUSED"===e.code)n="Can't connect! Deepstream server unreachable on "+t.originalUrl;else try{n=JSON.stringify(e)}catch(t){n=e.toString()}t.services.logger.error({topic:s.TOPIC.CONNECTION},o.EVENT.CONNECTION_ERROR,n)},1),this.services.timerRegistry.remove(this.heartbeatInterval),this.stateMachine.transition("error"),this.tryReconnect()}},{key:"onClose",value:function(){this.services.timerRegistry.remove(this.heartbeatInterval),this.stateMachine.state!==o.CONNECTION_STATE.REDIRECTING?this.stateMachine.state!==o.CONNECTION_STATE.CHALLENGE_DENIED&&this.stateMachine.state!==o.CONNECTION_STATE.TOO_MANY_AUTH_ATTEMPTS&&this.stateMachine.state!==o.CONNECTION_STATE.AUTHENTICATION_TIMEOUT&&(this.stateMachine.state!==o.CONNECTION_STATE.CLOSING?(this.stateMachine.transition("connection-lost"),this.tryReconnect()):this.stateMachine.transition("closed")):this.createEndpoint()}},{key:"onMessages",value:function(e){var t=this;e.forEach(function(e){if(e.parseError)t.services.logger.error({topic:s.TOPIC.PARSER},e.action,e.raw&&e.raw.toString());else{var n=e,i=a.parseData(n);if(!0!==i&&t.services.logger.error({topic:s.TOPIC.PARSER},s.PARSER_ACTIONS.INVALID_MESSAGE,i),null!==n)if(n.topic!==s.TOPIC.CONNECTION)if(n.topic!==s.TOPIC.AUTH){var r=t.handlers.get(n.topic);r&&r(n)}else t.handleAuthResponse(n);else t.handleConnectionResponse(n)}})}},{key:"sendAuthParams",value:function(){this.stateMachine.transition("authenticate"),this.sendMessage({topic:s.TOPIC.AUTH,action:s.AUTH_ACTIONS.REQUEST,parsedData:this.authParams})}},{key:"checkHeartBeat",value:function(){var e=2*this.options.heartbeatInterval;if(Date.now()-this.lastHeartBeat>e)return this.services.timerRegistry.remove(this.heartbeatInterval),this.services.logger.error({topic:s.TOPIC.CONNECTION},o.EVENT.HEARTBEAT_TIMEOUT),void this.endpoint.close();this.heartbeatInterval=this.services.timerRegistry.add({duration:this.options.heartbeatInterval,callback:this.checkHeartBeat,context:this})}},{key:"tryReconnect",value:function(){if(null===this.reconnectTimeout){if(this.reconnectionAttempt<this.options.maxReconnectAttempts)return this.stateMachine.transition("reconnect"),this.reconnectTimeout=setTimeout(this.tryOpen.bind(this),Math.min(this.options.maxReconnectInterval,this.options.reconnectIntervalIncrement*this.reconnectionAttempt)),void this.reconnectionAttempt++;this.emitter.emit(o.EVENT[o.EVENT.MAX_RECONNECTION_ATTEMPTS_REACHED],this.reconnectionAttempt),this.clearReconnect(),this.close()}}},{key:"tryOpen",value:function(){this.stateMachine.state!==o.CONNECTION_STATE.REDIRECTING&&(this.url=this.originalUrl),this.createEndpoint(),this.reconnectTimeout=null}},{key:"clearReconnect",value:function(){this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null,this.reconnectionAttempt=0}},{key:"handleConnectionResponse",value:function(e){if(e.action===s.CONNECTION_ACTIONS.PING)return this.lastHeartBeat=Date.now(),void this.sendMessage({topic:s.TOPIC.CONNECTION,action:s.CONNECTION_ACTIONS.PONG});if(e.action!==s.CONNECTION_ACTIONS.ACCEPT)return e.action===s.CONNECTION_ACTIONS.CHALLENGE?(this.stateMachine.transition("challenge"),void this.sendMessage({topic:s.TOPIC.CONNECTION,action:s.CONNECTION_ACTIONS.CHALLENGE_RESPONSE,url:this.originalUrl})):e.action===s.CONNECTION_ACTIONS.REJECT?(this.stateMachine.transition("challenge-denied"),void this.endpoint.close()):e.action===s.CONNECTION_ACTIONS.REDIRECT?(this.url=e.url,this.stateMachine.transition("redirected"),void this.endpoint.close()):void(e.action===s.CONNECTION_ACTIONS.AUTHENTICATION_TIMEOUT&&(this.deliberateClose=!0,this.stateMachine.transition("authentication-timeout"),this.services.logger.error(e)));this.stateMachine.transition("accepted")}},{key:"handleAuthResponse",value:function(e){return e.action===s.AUTH_ACTIONS.TOO_MANY_AUTH_ATTEMPTS?(this.deliberateClose=!0,this.stateMachine.transition("too-many-auth-attempts"),void this.services.logger.error(e)):e.action===s.AUTH_ACTIONS.AUTH_UNSUCCESSFUL?(this.stateMachine.transition("unsuccesful-login"),void this.authCallback(!1,{reason:o.EVENT[o.EVENT.INVALID_AUTHENTICATION_DETAILS]})):e.action===s.AUTH_ACTIONS.AUTH_SUCCESSFUL?(this.stateMachine.transition("succesful-login"),void this.authCallback(!0,e.parsedData||null)):void 0}},{key:"onAwaitingAuthentication",value:function(){this.authParams&&this.sendAuthParams()}}]),e}();t.Connection=h},function(e,t,n){"use strict";function i(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}function r(e,t,n){if(e&&s.isObject(e)&&e instanceof i)return e;var r=new i;return r.parse(e,t,n),r}var o=n(18),s=n(21);t.parse=r,t.resolve=function(e,t){return r(e,!1,!0).resolve(t)},t.resolveObject=function(e,t){return e?r(e,!1,!0).resolveObject(t):t},t.format=function(e){return s.isString(e)&&(e=r(e)),e instanceof i?e.format():i.prototype.format.call(e)},t.Url=i;var a=/^([a-z0-9.+-]+:)/i,c=/:[0-9]*$/,E=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,u=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),h=["'"].concat(u),l=["%","/","?",";","#"].concat(h),T=["/","?","#"],C=/^[+a-z0-9A-Z_-]{0,63}$/,R=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,N={javascript:!0,"javascript:":!0},O={javascript:!0,"javascript:":!0},f={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},I=n(22);i.prototype.parse=function(e,t,n){if(!s.isString(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var i=e.indexOf("?"),r=-1!==i&&i<e.indexOf("#")?"?":"#",c=e.split(r);c[0]=c[0].replace(/\\/g,"/");var u=e=c.join(r);if(u=u.trim(),!n&&1===e.split("#").length){var S=E.exec(u);if(S)return this.path=u,this.href=u,this.pathname=S[1],S[2]?(this.search=S[2],this.query=t?I.parse(this.search.substr(1)):this.search.substr(1)):t&&(this.search="",this.query={}),this}var A=a.exec(u);if(A){var _=(A=A[0]).toLowerCase();this.protocol=_,u=u.substr(A.length)}if(n||A||u.match(/^\/\/[^@\/]+@[^@\/]+/)){var d="//"===u.substr(0,2);!d||A&&O[A]||(u=u.substr(2),this.slashes=!0)}if(!O[A]&&(d||A&&!f[A])){for(var p=-1,v=0;v<T.length;v++){-1!==(g=u.indexOf(T[v]))&&(-1===p||g<p)&&(p=g)}var m,y;-1!==(y=-1===p?u.lastIndexOf("@"):u.lastIndexOf("@",p))&&(m=u.slice(0,y),u=u.slice(y+1),this.auth=decodeURIComponent(m)),p=-1;for(v=0;v<l.length;v++){var g=u.indexOf(l[v]);-1!==g&&(-1===p||g<p)&&(p=g)}-1===p&&(p=u.length),this.host=u.slice(0,p),u=u.slice(p),this.parseHost(),this.hostname=this.hostname||"";var b="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!b)for(var D=this.hostname.split(/\./),v=0,P=D.length;v<P;v++){var U=D[v];if(U&&!U.match(C)){for(var L="",k=0,M=U.length;k<M;k++)U.charCodeAt(k)>127?L+="x":L+=U[k];if(!L.match(C)){var w=D.slice(0,v),H=D.slice(v+1),V=U.match(R);V&&(w.push(V[1]),H.unshift(V[2])),H.length&&(u="/"+H.join(".")+u),this.hostname=w.join(".");break}}}this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),b||(this.hostname=o.toASCII(this.hostname));var B=this.port?":"+this.port:"",G=this.hostname||"";this.host=G+B,this.href+=this.host,b&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==u[0]&&(u="/"+u))}if(!N[_])for(var v=0,P=h.length;v<P;v++){var j=h[v];if(-1!==u.indexOf(j)){var W=encodeURIComponent(j);W===j&&(W=escape(j)),u=u.split(j).join(W)}}var K=u.indexOf("#");-1!==K&&(this.hash=u.substr(K),u=u.slice(0,K));var F=u.indexOf("?");if(-1!==F?(this.search=u.substr(F),this.query=u.substr(F+1),t&&(this.query=I.parse(this.query)),u=u.slice(0,F)):t&&(this.search="",this.query={}),u&&(this.pathname=u),f[_]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){var B=this.pathname||"",x=this.search||"";this.path=B+x}return this.href=this.format(),this},i.prototype.format=function(){var e=this.auth||"";e&&(e=(e=encodeURIComponent(e)).replace(/%3A/i,":"),e+="@");var t=this.protocol||"",n=this.pathname||"",i=this.hash||"",r=!1,o="";this.host?r=e+this.host:this.hostname&&(r=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(r+=":"+this.port)),this.query&&s.isObject(this.query)&&Object.keys(this.query).length&&(o=I.stringify(this.query));var a=this.search||o&&"?"+o||"";return t&&":"!==t.substr(-1)&&(t+=":"),this.slashes||(!t||f[t])&&!1!==r?(r="//"+(r||""),n&&"/"!==n.charAt(0)&&(n="/"+n)):r||(r=""),i&&"#"!==i.charAt(0)&&(i="#"+i),a&&"?"!==a.charAt(0)&&(a="?"+a),n=n.replace(/[?#]/g,function(e){return encodeURIComponent(e)}),a=a.replace("#","%23"),t+r+n+a+i},i.prototype.resolve=function(e){return this.resolveObject(r(e,!1,!0)).format()},i.prototype.resolveObject=function(e){if(s.isString(e)){var t=new i;t.parse(e,!1,!0),e=t}for(var n=new i,r=Object.keys(this),o=0;o<r.length;o++){var a=r[o];n[a]=this[a]}if(n.hash=e.hash,""===e.href)return n.href=n.format(),n;if(e.slashes&&!e.protocol){for(var c=Object.keys(e),E=0;E<c.length;E++){var u=c[E];"protocol"!==u&&(n[u]=e[u])}return f[n.protocol]&&n.hostname&&!n.pathname&&(n.path=n.pathname="/"),n.href=n.format(),n}if(e.protocol&&e.protocol!==n.protocol){if(!f[e.protocol]){for(var h=Object.keys(e),l=0;l<h.length;l++){var T=h[l];n[T]=e[T]}return n.href=n.format(),n}if(n.protocol=e.protocol,e.host||O[e.protocol])n.pathname=e.pathname;else{for(d=(e.pathname||"").split("/");d.length&&!(e.host=d.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==d[0]&&d.unshift(""),d.length<2&&d.unshift(""),n.pathname=d.join("/")}if(n.search=e.search,n.query=e.query,n.host=e.host||"",n.auth=e.auth,n.hostname=e.hostname||e.host,n.port=e.port,n.pathname||n.search){var C=n.pathname||"",R=n.search||"";n.path=C+R}return n.slashes=n.slashes||e.slashes,n.href=n.format(),n}var N=n.pathname&&"/"===n.pathname.charAt(0),I=e.host||e.pathname&&"/"===e.pathname.charAt(0),S=I||N||n.host&&e.pathname,A=S,_=n.pathname&&n.pathname.split("/")||[],d=e.pathname&&e.pathname.split("/")||[],p=n.protocol&&!f[n.protocol];if(p&&(n.hostname="",n.port=null,n.host&&(""===_[0]?_[0]=n.host:_.unshift(n.host)),n.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===d[0]?d[0]=e.host:d.unshift(e.host)),e.host=null),S=S&&(""===d[0]||""===_[0])),I)n.host=e.host||""===e.host?e.host:n.host,n.hostname=e.hostname||""===e.hostname?e.hostname:n.hostname,n.search=e.search,n.query=e.query,_=d;else if(d.length)_||(_=[]),_.pop(),_=_.concat(d),n.search=e.search,n.query=e.query;else if(!s.isNullOrUndefined(e.search)){if(p){n.hostname=n.host=_.shift();(D=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@"))&&(n.auth=D.shift(),n.host=n.hostname=D.shift())}return n.search=e.search,n.query=e.query,s.isNull(n.pathname)&&s.isNull(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.href=n.format(),n}if(!_.length)return n.pathname=null,n.search?n.path="/"+n.search:n.path=null,n.href=n.format(),n;for(var v=_.slice(-1)[0],m=(n.host||e.host||_.length>1)&&("."===v||".."===v)||""===v,y=0,g=_.length;g>=0;g--)"."===(v=_[g])?_.splice(g,1):".."===v?(_.splice(g,1),y++):y&&(_.splice(g,1),y--);if(!S&&!A)for(;y--;y)_.unshift("..");!S||""===_[0]||_[0]&&"/"===_[0].charAt(0)||_.unshift(""),m&&"/"!==_.join("/").substr(-1)&&_.push("");var b=""===_[0]||_[0]&&"/"===_[0].charAt(0);if(p){n.hostname=n.host=b?"":_.length?_.shift():"";var D=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@");D&&(n.auth=D.shift(),n.host=n.hostname=D.shift())}return(S=S||n.host&&_.length)&&!b&&_.unshift(""),_.length?n.pathname=_.join("/"):(n.pathname=null,n.path=null),s.isNull(n.pathname)&&s.isNull(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.auth=e.auth||n.auth,n.slashes=n.slashes||e.slashes,n.href=n.format(),n},i.prototype.parseHost=function(){var e=this.host,t=c.exec(e);t&&(":"!==(t=t[0])&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)}},function(e,t,n){(function(e,i){var r;!function(o){function s(e){throw new RangeError(D[e])}function a(e,t){for(var n=e.length,i=[];n--;)i[n]=t(e[n]);return i}function c(e,t){var n=e.split("@"),i="";n.length>1&&(i=n[0]+"@",e=n[1]);return i+a((e=e.replace(b,".")).split("."),t).join(".")}function E(e){for(var t,n,i=[],r=0,o=e.length;r<o;)(t=e.charCodeAt(r++))>=55296&&t<=56319&&r<o?56320==(64512&(n=e.charCodeAt(r++)))?i.push(((1023&t)<<10)+(1023&n)+65536):(i.push(t),r--):i.push(t);return i}function u(e){return a(e,function(e){var t="";return e>65535&&(t+=L((e-=65536)>>>10&1023|55296),e=56320|1023&e),t+=L(e)}).join("")}function h(e){return e-48<10?e-22:e-65<26?e-65:e-97<26?e-97:I}function l(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function T(e,t,n){var i=0;for(e=n?U(e/d):e>>1,e+=U(e/t);e>P*A>>1;i+=I)e=U(e/P);return U(i+(P+1)*e/(e+_))}function C(e){var t,n,i,r,o,a,c,E,l,C,R=[],N=e.length,O=0,_=v,d=p;for((n=e.lastIndexOf(m))<0&&(n=0),i=0;i<n;++i)e.charCodeAt(i)>=128&&s("not-basic"),R.push(e.charCodeAt(i));for(r=n>0?n+1:0;r<N;){for(o=O,a=1,c=I;r>=N&&s("invalid-input"),((E=h(e.charCodeAt(r++)))>=I||E>U((f-O)/a))&&s("overflow"),O+=E*a,l=c<=d?S:c>=d+A?A:c-d,!(E<l);c+=I)a>U(f/(C=I-l))&&s("overflow"),a*=C;d=T(O-o,t=R.length+1,0==o),U(O/t)>f-_&&s("overflow"),_+=U(O/t),O%=t,R.splice(O++,0,_)}return u(R)}function R(e){var t,n,i,r,o,a,c,u,h,C,R,N,O,_,d,y=[];for(N=(e=E(e)).length,t=v,n=0,o=p,a=0;a<N;++a)(R=e[a])<128&&y.push(L(R));for(i=r=y.length,r&&y.push(m);i<N;){for(c=f,a=0;a<N;++a)(R=e[a])>=t&&R<c&&(c=R);for(c-t>U((f-n)/(O=i+1))&&s("overflow"),n+=(c-t)*O,t=c,a=0;a<N;++a)if((R=e[a])<t&&++n>f&&s("overflow"),R==t){for(u=n,h=I;C=h<=o?S:h>=o+A?A:h-o,!(u<C);h+=I)d=u-C,_=I-C,y.push(L(l(C+d%_,0))),u=U(d/_);y.push(L(l(u,0))),o=T(n,O,i==r),n=0,++i}++n,++t}return y.join("")}"object"==typeof t&&t&&t.nodeType,"object"==typeof e&&e&&e.nodeType;var N="object"==typeof i&&i;var O,f=2147483647,I=36,S=1,A=26,_=38,d=700,p=72,v=128,m="-",y=/^xn--/,g=/[^\x20-\x7E]/,b=/[\x2E\u3002\uFF0E\uFF61]/g,D={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},P=I-S,U=Math.floor,L=String.fromCharCode;O={version:"1.4.1",ucs2:{decode:E,encode:u},decode:C,encode:R,toASCII:function(e){return c(e,function(e){return g.test(e)?"xn--"+R(e):e})},toUnicode:function(e){return c(e,function(e){return y.test(e)?C(e.slice(4).toLowerCase()):e})}},void 0!==(r=function(){return O}.call(t,n,t,e))&&(e.exports=r)}()}).call(t,n(19)(e),n(20))},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";e.exports={isString:function(e){return"string"==typeof e},isObject:function(e){return"object"==typeof e&&null!==e},isNull:function(e){return null===e},isNullOrUndefined:function(e){return null==e}}},function(e,t,n){"use strict";t.decode=t.parse=n(23),t.encode=t.stringify=n(24)},function(e,t,n){"use strict";function i(e,t){return Object.prototype.hasOwnProperty.call(e,t)}e.exports=function(e,t,n,o){t=t||"&",n=n||"=";var s={};if("string"!=typeof e||0===e.length)return s;var a=/\+/g;e=e.split(t);var c=1e3;o&&"number"==typeof o.maxKeys&&(c=o.maxKeys);var E=e.length;c>0&&E>c&&(E=c);for(var u=0;u<E;++u){var h,l,T,C,R=e[u].replace(a,"%20"),N=R.indexOf(n);N>=0?(h=R.substr(0,N),l=R.substr(N+1)):(h=R,l=""),T=decodeURIComponent(h),C=decodeURIComponent(l),i(s,T)?r(s[T])?s[T].push(C):s[T]=[s[T],C]:s[T]=C}return s};var r=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)}},function(e,t,n){"use strict";function i(e,t){if(e.map)return e.map(t);for(var n=[],i=0;i<e.length;i++)n.push(t(e[i],i));return n}var r=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};e.exports=function(e,t,n,a){return t=t||"&",n=n||"=",null===e&&(e=void 0),"object"==typeof e?i(s(e),function(s){var a=encodeURIComponent(r(s))+n;return o(e[s])?i(e[s],function(e){return a+encodeURIComponent(r(e))}).join(t):a+encodeURIComponent(r(e[s]))}).join(t):a?encodeURIComponent(r(a))+n+encodeURIComponent(r(e)):""};var o=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},s=Object.keys||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(5),r=n(26),o=n(0),s=n(!function(){var e=new Error('Cannot find module "ws"');throw e.code="MODULE_NOT_FOUND",e}());t.socketFactory=function(e,t){var n=new s(e,t);return n.onparsedmessage=function(){},n.onmessage=function(e){var t=i.parse(e.data);t.forEach(function(e){var t=e;console.log("<<<",o.TOPIC[t.topic],o.ACTIONS[t.topic][t.action],t.parsedData,t.data,t.name)}),n.onparsedmessages(t)},n.sendParsedMessage=function(e){if(e.topic===o.TOPIC.CONNECTION&&e.action===o.CONNECTION_ACTIONS.CLOSING)return n.onparsedmessages([{topic:o.TOPIC.CONNECTION,action:o.CONNECTION_ACTIONS.CLOSED}]),void n.close();e.data=JSON.stringify(e.parsedData),console.log(">>>",o.TOPIC[e.topic],o.ACTIONS[e.topic][e.action],e.parsedData,e.reason,e.name),n.send(r.getMessage(e,!1))},n}},function(e,t,n){"use strict";(function(e){function i(t,n){var i=t,c=i.action,E=a.validate(i);E&&console.error("invalid message "+o.TOPIC[i.topic]+" "+i.action+": "+E),i.isWriteAck&&!s.isWriteAck(i.action)&&(c=s.actionToWriteAck[i.action]),(i.isAck||n)&&(c|=128);var u=Object.create(null);for(var h in o.META_KEYS)u[o.META_KEYS[h]]=i[h];u[o.META_KEYS.payloadEncoding]===o.PAYLOAD_ENCODING.JSON&&delete u[o.META_KEYS.payloadEncoding];var l="{}"===JSON.stringify(u)?null:e.from(JSON.stringify(u),"utf8"),T=void 0;if(i.data instanceof e)T=i.data;else if(void 0!==i.data||void 0!==i.parsedData){var C=i.data;void 0===C&&(C=JSON.stringify(i.parsedData)),T=e.from(C,"utf8")}else T=null;T&&!a.hasPayload(i.topic,c)&&console.error("invalid message "+o.TOPIC[i.topic]+" "+i.action+": should not have payload");var R=l?l.length:0,N=T?T.length:0;return R<=s.META_PAYLOAD_OVERFLOW_LENGTH&&N<=s.META_PAYLOAD_OVERFLOW_LENGTH?r(!0,i.topic,c,l,T):function(t,n,i,o){var a=i?i.length:0,c=o?o.length:0,E=[],u=0,h=0,l=void 0;do{var T=Math.min(a-u,s.META_PAYLOAD_OVERFLOW_LENGTH),C=Math.min(c-h,s.META_PAYLOAD_OVERFLOW_LENGTH),R=i&&i.slice(u,u+T),N=o&&o.slice(h,h+C);h+=C,l=(u+=T)===a&&h===c,E.push(r(l,t,n,R,N))}while(!l);return e.concat(E)}(i.topic,c,l,T)}function r(t,n,i,r,o){var a=r?r.length:0,c=o?o.length:0,E=s.HEADER_LENGTH+a+c,u=e.allocUnsafe(E);return u[0]=(t?128:0)|n,u[1]=i,u.writeUIntBE(a,2,3),u.writeUIntBE(c,5,3),r&&r.copy(u,s.HEADER_LENGTH),o&&o.copy(u,s.HEADER_LENGTH+a),u}Object.defineProperty(t,"__esModule",{value:!0});var o=n(0),s=n(6),a=n(7);t.getMessage=i}).call(t,n(!function(){var e=new Error('Cannot find module "./../../node_modules/node-libs-browser/node_modules/buffer/index.js"');throw e.code="MODULE_NOT_FOUND",e}()).Buffer)},function(e,t,n){"use strict";var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),o=n(1),s=n(9),a=n(2),c=function(){function e(t,n,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.options=n,this.services=t,this.listeners=i||new s.Listener(r.TOPIC.EVENT,t),this.emitter=new a,this.services.connection.registerHandler(r.TOPIC.EVENT,this.handle.bind(this)),this.services.connection.onReestablished(this.resubscribe.bind(this))}return i(e,[{key:"subscribe",value:function(e,t){if("string"!=typeof e||0===e.length)throw new Error("invalid argument name");if("function"!=typeof t)throw new Error("invalid argument callback");this.emitter.hasListeners(e)||this.sendSubscriptionMessage(e),this.emitter.on(e,t)}},{key:"unsubscribe",value:function(e,t){if(!e||"string"!=typeof e||0===e.length)throw new Error("invalid argument name");if(void 0!==t&&"function"!=typeof t)throw new Error("invalid argument callback");if(this.emitter.hasListeners(e)){if(this.emitter.off(e,t),!this.emitter.hasListeners(e)){var n={topic:r.TOPIC.EVENT,action:r.EVENT_ACTIONS.UNSUBSCRIBE,name:e};this.services.timeoutRegistry.add({message:n}),this.services.connection.sendMessage(n)}}else this.services.logger.warn({topic:r.TOPIC.EVENT,action:r.EVENT_ACTIONS.NOT_SUBSCRIBED,name:e})}},{key:"emit",value:function(e,t){if("string"!=typeof e||0===e.length)throw new Error("invalid argument name");this.services.connection.isConnected&&this.services.connection.sendMessage({topic:r.TOPIC.EVENT,action:r.EVENT_ACTIONS.EMIT,name:e,parsedData:t}),this.emitter.emit(e,t)}},{key:"listen",value:function(e,t){this.listeners.listen(e,t)}},{key:"unlisten",value:function(e){this.listeners.unlisten(e)}},{key:"handle",value:function(e){if(e.isAck)this.services.timeoutRegistry.remove(e);else{if(e.action!==r.EVENT_ACTIONS.EMIT)return e.action===r.EVENT_ACTIONS.MESSAGE_DENIED?(this.services.logger.error({topic:r.TOPIC.EVENT},r.EVENT_ACTIONS.MESSAGE_DENIED),this.services.timeoutRegistry.remove(e),void(e.originalAction===r.EVENT_ACTIONS.SUBSCRIBE&&this.emitter.off(e.name))):e.action===r.EVENT_ACTIONS.NOT_SUBSCRIBED||e.action===r.EVENT_ACTIONS.MULTIPLE_SUBSCRIPTIONS?(this.services.timeoutRegistry.remove(e),void this.services.logger.warn(e)):void(e.action!==r.EVENT_ACTIONS.SUBSCRIPTION_FOR_PATTERN_FOUND&&e.action!==r.EVENT_ACTIONS.SUBSCRIPTION_FOR_PATTERN_REMOVED?this.services.logger.error(e,o.EVENT.UNSOLICITED_MESSAGE):this.listeners.handle(e));void 0!==e.parsedData?this.emitter.emit(e.name,e.parsedData):this.emitter.emit(e.name,void 0)}}},{key:"resubscribe",value:function(){var e=this.emitter.eventNames(),t=!0,n=!1,i=void 0;try{for(var r,o=e[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){var s=r.value;this.sendSubscriptionMessage(s)}}catch(e){n=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw i}}}},{key:"sendSubscriptionMessage",value:function(e){var t={topic:r.TOPIC.EVENT,action:r.EVENT_ACTIONS.SUBSCRIBE,name:e};this.services.timeoutRegistry.add({message:t}),this.services.connection.sendMessage(t)}}]),e}();t.EventHandler=c},function(e,t,n){"use strict";var i=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],i=!0,r=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(i=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);i=!0);}catch(e){r=!0,o=e}finally{try{!i&&a.return&&a.return()}finally{if(r)throw o}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(0),s=n(1),a=n(29),c=n(30),E=n(3),u=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.services=t,this.options=n,this.rpcs=new Map,this.providers=new Map,this.services.connection.registerHandler(o.TOPIC.RPC,this.handle.bind(this)),this.services.connection.onReestablished(this.reprovide.bind(this))}return r(e,[{key:"provide",value:function(e,t){if("string"!=typeof e||0===e.length)throw new Error("invalid argument name");if(this.providers.has(e))throw new Error("RPC "+e+" already registered");if("function"!=typeof t)throw new Error("invalid argument callback");this.providers.set(e,t),this.services.connection.isConnected&&this.sendProvide(e)}},{key:"unprovide",value:function(e){if("string"!=typeof e||0===e.length)throw new Error("invalid argument name");if(this.providers.has(e)){if(this.providers.delete(e),this.services.connection.isConnected){var t={topic:o.TOPIC.RPC,action:o.RPC_ACTIONS.UNPROVIDE,name:e};return this.services.timeoutRegistry.add({message:t}),void this.services.connection.sendMessage(t)}}else this.services.logger.warn({topic:o.TOPIC.RPC,action:o.RPC_ACTIONS.NOT_PROVIDED,name:e})}},{key:"make",value:function(e,t,n){var i=this;if("string"!=typeof e||0===e.length)throw new Error("invalid argument name");if(n&&"function"!=typeof n)throw new Error("invalid argument callback");if(!1===this.services.connection.isConnected)return n?void this.services.timerRegistry.requestIdleCallback(n.bind(this,s.EVENT.CLIENT_OFFLINE)):Promise.reject(s.EVENT.CLIENT_OFFLINE);var r=E.getUid();this.services.connection.sendMessage({topic:o.TOPIC.RPC,action:o.RPC_ACTIONS.REQUEST,correlationId:r,name:e,parsedData:t});if(!n)return new Promise(function(t,n){i.rpcs.set(r,new a.RPC(e,r,function(e,i){e?n(e):t(i)},i.options,i.services))});this.rpcs.set(r,new a.RPC(e,r,n,this.options,this.services))}},{key:"respondToRpc",value:function(e){var t=this.providers.get(e.name);t?t(e.parsedData,new c.RPCResponse(e,this.options,this.services)):this.services.connection.sendMessage({topic:o.TOPIC.RPC,action:o.RPC_ACTIONS.REJECT,name:e.name,correlationId:e.correlationId})}},{key:"handle",value:function(e){if(e.action!==o.RPC_ACTIONS.REQUEST)if(e.isAck)this.services.timeoutRegistry.remove(e);else{if(e.action===o.RPC_ACTIONS.MESSAGE_PERMISSION_ERROR||e.action===o.RPC_ACTIONS.MESSAGE_DENIED){if(e.originalAction===o.RPC_ACTIONS.PROVIDE||e.originalAction===o.RPC_ACTIONS.UNPROVIDE)return this.services.timeoutRegistry.remove(e),this.providers.delete(e.name),void this.services.logger.error(e);if(e.originalAction===o.RPC_ACTIONS.REQUEST){var t=this.getRPC(e);if(t)return t.error(o.RPC_ACTIONS[e.action]),void this.rpcs.delete(e.correlationId)}}var n=this.getRPC(e);if(n){if(e.action===o.RPC_ACTIONS.ACCEPT)return void n.accept();e.action===o.RPC_ACTIONS.RESPONSE?n.respond(e.parsedData):e.action===o.RPC_ACTIONS.REQUEST_ERROR?n.error(e.parsedData):e.action!==o.RPC_ACTIONS.RESPONSE_TIMEOUT&&e.action!==o.RPC_ACTIONS.NO_RPC_PROVIDER||n.error(o.RPC_ACTIONS[e.action]),this.rpcs.delete(e.correlationId)}}else this.respondToRpc(e)}},{key:"getRPC",value:function(e){var t=this.rpcs.get(e.correlationId);return void 0===t&&this.services.logger.error(e,s.EVENT.UNKNOWN_CORRELATION_ID),t}},{key:"reprovide",value:function(){var e=!0,t=!1,n=void 0;try{for(var r,o=this.providers[Symbol.iterator]();!(e=(r=o.next()).done);e=!0){var s=r.value,a=i(s,2),c=a[0];a[1];this.sendProvide(c)}}catch(e){t=!0,n=e}finally{try{!e&&o.return&&o.return()}finally{if(t)throw n}}}},{key:"sendProvide",value:function(e){var t={topic:o.TOPIC.RPC,action:o.RPC_ACTIONS.PROVIDE,name:e};this.services.timeoutRegistry.add({message:t}),this.services.connection.sendMessage(t)}}]),e}();t.RPCHandler=u},function(e,t,n){"use strict";var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),o=function(){function e(t,n,i,o,s){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.options=o,this.services=s,this.name=t,this.response=i,this.acceptTimeout=this.services.timeoutRegistry.add({message:{topic:r.TOPIC.RPC,action:r.RPC_ACTIONS.ACCEPT,name:t,correlationId:n},event:r.RPC_ACTIONS.ACCEPT_TIMEOUT,duration:this.options.rpcAcceptTimeout,callback:this.onTimeout.bind(this)}),this.responseTimeout=this.services.timeoutRegistry.add({message:{topic:r.TOPIC.RPC,action:r.RPC_ACTIONS.REQUEST,name:t,correlationId:n},event:r.RPC_ACTIONS.RESPONSE_TIMEOUT,duration:this.options.rpcResponseTimeout,callback:this.onTimeout.bind(this)})}return i(e,[{key:"accept",value:function(){this.services.timeoutRegistry.clear(this.acceptTimeout)}},{key:"respond",value:function(e){this.response(null,e),this.complete()}},{key:"error",value:function(e){this.response(e),this.complete()}},{key:"onTimeout",value:function(e,t){this.response(r.RPC_ACTIONS[e]),this.complete()}},{key:"complete",value:function(){this.services.timeoutRegistry.clear(this.acceptTimeout),this.services.timeoutRegistry.clear(this.responseTimeout)}}]),e}();t.RPC=o},function(e,t,n){"use strict";var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),o=function(){function e(t,n,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.name=t.name,this.correlationId=t.correlationId,this.options=n,this.services=i,this.isAccepted=!1,this.isComplete=!1,this.autoAccept=!0,this.services.timerRegistry.requestIdleCallback(this.performAutoAck.bind(this))}return i(e,[{key:"accept",value:function(){!1===this.isAccepted&&(this.services.connection.sendMessage({topic:r.TOPIC.RPC,action:r.RPC_ACTIONS.ACCEPT,name:this.name,correlationId:this.correlationId}),this.isAccepted=!0)}},{key:"reject",value:function(){if(!0===this.isComplete)throw new Error("Rpc "+this.name+" already completed");this.autoAccept=!1,this.isComplete=!0,this.isAccepted=!0,this.services.connection.sendMessage({topic:r.TOPIC.RPC,action:r.RPC_ACTIONS.REJECT,name:this.name,correlationId:this.correlationId})}},{key:"error",value:function(e){if(!0===this.isComplete)throw new Error("Rpc "+this.name+" already completed");this.autoAccept=!1,this.isComplete=!0,this.isAccepted=!0,this.services.connection.sendMessage({topic:r.TOPIC.RPC,action:r.RPC_ACTIONS.REQUEST_ERROR,name:this.name,correlationId:this.correlationId,parsedData:e})}},{key:"send",value:function(e){if(!0===this.isComplete)throw new Error("Rpc "+this.name+" already completed");this.accept(),this.services.connection.sendMessage({topic:r.TOPIC.RPC,action:r.RPC_ACTIONS.RESPONSE,name:this.name,correlationId:this.correlationId,parsedData:e}),this.isComplete=!0}},{key:"performAutoAck",value:function(){!0===this.autoAccept&&this.accept()}}]),e}();t.RPCResponse=o},function(e,t,n){"use strict";var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(3),s=n(1),a=n(0),c=n(32),E=n(34),u=n(35),h=n(36),l=n(9),T=n(37),C=n(2),R=function(){function e(t,n,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.services=t,this.options=n,this.emitter=new C,this.listener=i||new l.Listener(a.TOPIC.RECORD,this.services),this.recordCores=new Map,this.readRegistry=new T.SingleNotifier(t,a.TOPIC.RECORD,a.RECORD_ACTIONS.READ,n.recordReadTimeout),this.headRegistry=new T.SingleNotifier(t,a.TOPIC.RECORD,a.RECORD_ACTIONS.HEAD,n.recordReadTimeout),this.getRecordCore=this.getRecordCore.bind(this),this.services.connection.registerHandler(a.TOPIC.RECORD,this.handle.bind(this))}return r(e,[{key:"getRecord",value:function(e){return new E.Record(this.getRecordCore(e))}},{key:"getList",value:function(e){return new h.List(this.getRecordCore(e))}},{key:"getAnonymousRecord",value:function(){return new u.AnonymousRecord(this.getRecordCore)}},{key:"listen",value:function(e,t){this.listener.listen(e,t)}},{key:"unlisten",value:function(e){this.listener.unlisten(e)}},{key:"snapshot",value:function(e,t){var n=this;if("string"!=typeof e||0===e.length)throw new Error("invalid argument: name");if(void 0!==t&&"function"!=typeof t)throw new Error("invalid argument: callback");var i=this.recordCores.get(e);return i&&i.isReady?t?void t(null,i.get()):Promise.resolve(i.get()):t?void this.readRegistry.request(e,{callback:t}):new Promise(function(t,i){n.readRegistry.request(e,{resolve:t,reject:i})})}},{key:"has",value:function(e,t){var n=this;if("string"!=typeof e||0===e.length)throw new Error("invalid argument: name");if(void 0!==t&&"function"!=typeof t)throw new Error("invalid argument: callback");if(!t)return new Promise(function(t,i){n.head(e,function(e,n){e&&e===a.RECORD_ACTIONS[a.RECORD_ACTIONS.RECORD_NOT_FOUND]?t(!1):e?i(e):t(-1!==n)})});this.head(e,function(e,n){e&&e===a.RECORD_ACTIONS[a.RECORD_ACTIONS.RECORD_NOT_FOUND]?t(null,!1):e?t(e,null):t(null,-1!==n)})}},{key:"head",value:function(e,t){var n=this;if("string"!=typeof e||0===e.length)throw new Error("invalid argument: name");if(void 0!==t&&"function"!=typeof t)throw new Error("invalid argument: callback");var i=this.recordCores.get(e);return i&&i.isReady?t?void t(null,i.version):Promise.resolve(i.version):t?void this.headRegistry.request(e,{callback:t}):new Promise(function(t,i){n.headRegistry.request(e,{resolve:t,reject:i})})}},{key:"setDataWithAck",value:function(e){for(var t=this,n=arguments.length,i=Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];var s=o.normalizeSetArguments(arguments,1);if(s.callback)return new Promise(function(n,i){s.callback=function(e){return null===e?n():i(e)},t.setData(e,s)});this.setData(e,s)}},{key:"setData",value:function(e){var t=o.normalizeSetArguments(arguments,1),n=t.path,r=t.data,s=t.callback;if(!n&&(null===r||"object"!==(void 0===r?"undefined":i(r))))throw new Error("invalid argument: data must be an object when no path is provided");var c=this.recordCores.get(e);if(c)c.set({path:n,data:r,callback:s});else{var E=void 0;E=n?s?a.RECORD_ACTIONS.CREATEANDPATCH_WITH_WRITE_ACK:a.RECORD_ACTIONS.CREATEANDPATCH:s?a.RECORD_ACTIONS.CREATEANDUPDATE_WITH_WRITE_ACK:a.RECORD_ACTIONS.CREATEANDUPDATE,this.services.connection.sendMessage({topic:a.TOPIC.RECORD,action:E,name:e,version:-1})}}},{key:"handle",value:function(e){if(e.action!==a.RECORD_ACTIONS.SUBSCRIPTION_FOR_PATTERN_FOUND&&e.action!==a.RECORD_ACTIONS.SUBSCRIPTION_FOR_PATTERN_REMOVED){var t=this.recordCores.get(e.name);t?t.handle(e):e.action!==a.RECORD_ACTIONS.VERSION_EXISTS&&(e.action===a.RECORD_ACTIONS.MESSAGE_DENIED||(e.action,a.RECORD_ACTIONS.MESSAGE_PERMISSION_ERROR),e.action!==a.RECORD_ACTIONS.READ_RESPONSE&&e.originalAction!==a.RECORD_ACTIONS.READ?e.action!==a.RECORD_ACTIONS.HEAD_RESPONSE&&e.originalAction!==a.RECORD_ACTIONS.HEAD?(e.action,a.RECORD_ACTIONS.DELETED,e.action!==a.RECORD_ACTIONS.WRITE_ACKNOWLEDGEMENT&&e.action!==a.RECORD_ACTIONS.SUBSCRIPTION_HAS_PROVIDER&&e.action!==a.RECORD_ACTIONS.SUBSCRIPTION_HAS_NO_PROVIDER&&this.services.logger.error(e,s.EVENT.UNSOLICITED_MESSAGE)):e.isError?this.headRegistry.recieve(e,a.RECORD_ACTIONS[e.action],void 0):this.headRegistry.recieve(e,null,e.version):e.isError?this.readRegistry.recieve(e,a.RECORD_ACTIONS[e.action],void 0):this.readRegistry.recieve(e,null,e.parsedData))}else this.listener.handle(e)}},{key:"removeRecord",value:function(e){this.recordCores.delete(e)}},{key:"getRecordCore",value:function(e){var t=this.recordCores.get(e);return t?t.usages++:(t=new c.RecordCore(e,this.services,this.options,this.removeRecord.bind(this)),this.recordCores.set(e,t)),t}}]),e}();t.RecordHandler=R},function(e,t,n){"use strict";var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(1),s=n(0),a=n(33),c=n(2),E=n(3),u=n(8),h=function(e){function t(e,n,i,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var a=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));if(a.services=n,a.options=i,a.emitter=new c,a.data=Object.create(null),a.writeCallbacks=new Map,a.name=e,a.whenComplete=r,a.references=1,a.offlineDirty=!1,"string"!=typeof e||0===e.length)throw new Error("invalid argument name");return a.setMergeStrategy(i.mergeStrategy),a.stateMachine=new u.StateMachine(a.services.logger,{init:0,onStateChanged:function(e,t){a.emitter.emit(o.EVENT.RECORD_STATE_CHANGED,e)},transitions:[{name:s.RECORD_ACTIONS.SUBSCRIBE,from:0,to:1,handler:a.onSubscribing.bind(a)},{name:0,from:0,to:3,handler:a.onOfflineLoading.bind(a)},{name:1,from:3,to:4,handler:a.onReady.bind(a)},{name:s.RECORD_ACTIONS.READ_RESPONSE,from:1,to:4,handler:a.onReady.bind(a)},{name:2,from:4,to:2,handler:a.onResubscribing.bind(a)},{name:3,from:2,to:4},{name:4,from:2,to:5},{name:s.RECORD_ACTIONS.DELETE,from:4,to:8},{name:s.RECORD_ACTIONS.DELETED,from:4,to:9,handler:a.onDeleted.bind(a)},{name:s.RECORD_ACTIONS.DELETE_SUCCESS,from:8,to:9,handler:a.onDeleted.bind(a)},{name:s.RECORD_ACTIONS.UNSUBSCRIBE,from:4,to:6},{name:s.RECORD_ACTIONS.SUBSCRIBE,from:6,to:4},{name:s.RECORD_ACTIONS.UNSUBSCRIBE_ACK,from:6,to:7,handler:a.onUnsubscribed.bind(a)},{name:4,from:4,to:5}]}),a.services.connection.isConnected?a.stateMachine.transition(s.RECORD_ACTIONS.SUBSCRIBE):a.stateMachine.transition(0),a}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,c),r(t,[{key:"whenReady",value:function(e,t){var n=this;return!0===this.isReady?t?void t(e):Promise.resolve(e):t?void this.once(o.EVENT.RECORD_READY,function(){return t(e)}):new Promise(function(t,i){n.once(o.EVENT.RECORD_READY,function(){return t(e)})})}},{key:"set",value:function(e){var t=e.path,n=e.data,r=e.callback;if(!t&&(null===n||"object"!==(void 0===n?"undefined":i(n))))throw new Error("invalid arguments, scalar values cannot be set without path");if(!this.checkDestroyed("set")&&this.isReady){var s=this.data,c=a.setValue(s,t||null,n);if(s!==c){var E=!1;r&&(E=!0,this.services.connection.isConnected?this.setupWriteCallback(this.version,r):this.services.timerRegistry.requestIdleCallback(function(){return r(o.EVENT.CLIENT_OFFLINE)})),this.applyChange(c),this.services.connection.isConnected?this.sendUpdate(t,n,E):this.saveUpdate()}else r&&this.services.timerRegistry.requestIdleCallback(function(){return r(null)})}}},{key:"setWithAck",value:function(e){var t=this;if(!e.callback)return new Promise(function(n,i){e.callback=function(e){return null===e?n():i(e)},t.set(e)});this.set(e)}},{key:"get",value:function(e){return a.get(this.data,e||null,this.options.recordDeepCopy)}},{key:"subscribe",value:function(e){var t=this;if(void 0!==e.path&&("string"!=typeof e.path||0===e.path.length))throw new Error("invalid argument path");if("function"!=typeof e.callback)throw new Error("invalid argument callback");this.checkDestroyed("subscribe")||(e.triggerNow?this.whenReady(null,function(){t.emitter.on(e.path||"",e.callback),e.callback(t.get(e.path))}):this.emitter.on(e.path||"",e.callback))}},{key:"unsubscribe",value:function(e){if(void 0!==e.path&&("string"!=typeof e.path||0===e.path.length))throw new Error("invalid argument path");if(void 0!==e.callback&&"function"!=typeof e.callback)throw new Error("invalid argument callback");this.checkDestroyed("unsubscribe")||this.emitter.off(e.path||"",e.callback)}},{key:"discard",value:function(){var e=this;this.checkDestroyed("discard")||(this.whenReady(null,function(){e.references--,e.references<=0&&(e.discardTimeout=e.services.timerRegistry.add({duration:e.options.discardTimeout,callback:e.stateMachine.transition,context:e.stateMachine,data:s.RECORD_ACTIONS.UNSUBSCRIBE_ACK}))}),this.stateMachine.transition(s.RECORD_ACTIONS.UNSUBSCRIBE))}},{key:"delete",value:function(e){var t=this;if(!this.checkDestroyed("delete")){if(this.stateMachine.transition(s.RECORD_ACTIONS.DELETE),!e||"function"!=typeof e)return new Promise(function(e,n){t.deleteResponse={resolve:e,reject:n},t.sendDelete()});this.deleteResponse={callback:e},this.sendDelete()}}},{key:"setMergeStrategy",value:function(e){if("function"!=typeof e)throw new Error("Invalid merge strategy: Must be a Function");this.mergeStrategy=e}},{key:"onSubscribing",value:function(){this.services.timeoutRegistry.add({message:{topic:s.TOPIC.RECORD,action:s.RECORD_ACTIONS.SUBSCRIBE,name:this.name}}),this.responseTimeout=this.services.timeoutRegistry.add({message:{topic:s.TOPIC.RECORD,action:s.RECORD_ACTIONS.READ_RESPONSE,name:this.name}}),this.services.connection.sendMessage({topic:s.TOPIC.RECORD,action:s.RECORD_ACTIONS.SUBSCRIBECREATEANDREAD,name:this.name})}},{key:"onResubscribing",value:function(){this.services.timeoutRegistry.add({message:{topic:s.TOPIC.RECORD,action:s.RECORD_ACTIONS.SUBSCRIBE,name:this.name}}),this.responseTimeout=this.services.timeoutRegistry.add({message:{topic:s.TOPIC.RECORD,action:s.RECORD_ACTIONS.HEAD_RESPONSE,name:this.name}}),this.services.connection.sendMessage({topic:s.TOPIC.RECORD,action:s.RECORD_ACTIONS.SUBSCRIBEANDHEAD,name:this.name})}},{key:"onOfflineLoading",value:function(){var e=this;this.services.storage.get(this.name,function(t,n,i){-1===e.version?(e.data={},e.version=1):(e.data=i,e.version=n),e.stateMachine.transition(1)})}},{key:"onReady",value:function(){this.isReady=!0,this.emit(o.EVENT.RECORD_READY)}},{key:"onUnsubscribed",value:function(){if(this.services.connection.isConnected){var e={topic:s.TOPIC.RECORD,action:s.RECORD_ACTIONS.UNSUBSCRIBE,name:this.name};this.services.timeoutRegistry.add({message:e}),this.services.connection.sendMessage(e)}this.emit(o.EVENT.RECORD_DISCARDED),this.destroy()}},{key:"onDeleted",value:function(){console.log("onDeleted"),this.emit(o.EVENT.RECORD_DELETED),this.destroy()}},{key:"handle",value:function(e){if(e.action===s.RECORD_ACTIONS.READ_RESPONSE)return 5===this.stateMachine.state?void this.recoverRecord(e.version,e.parsedData,e):(this.version=e.version,this.applyChange(a.setValue(this.data,null,e.parsedData)),void this.stateMachine.transition(s.RECORD_ACTIONS.READ_RESPONSE));if(e.action===s.RECORD_ACTIONS.HEAD_RESPONSE)return this.version===e.version?void this.stateMachine.transition(3):this.version+1===e.version?(this.version=e.version,this.applyChange(a.setValue(this.data,null,e.parsedData)),void this.stateMachine.transition(3)):(this.stateMachine.transition(4),void this.sendRead());if(e.action!==s.RECORD_ACTIONS.PATCH&&e.action!==s.RECORD_ACTIONS.UPDATE){if(e.action===s.RECORD_ACTIONS.DELETE_SUCCESS)return this.stateMachine.transition(e.action),void(this.deleteResponse.callback?this.deleteResponse.callback(null):this.deleteResponse.resolve&&this.deleteResponse.resolve());if(e.action===s.RECORD_ACTIONS.DELETED&&this.stateMachine.transition(e.action),e.action!==s.RECORD_ACTIONS.VERSION_EXISTS){if(e.action===s.RECORD_ACTIONS.MESSAGE_DENIED)return e.originalAction!==s.RECORD_ACTIONS.PATCH&&e.originalAction!==s.RECORD_ACTIONS.UPDATE&&e.originalAction!==s.RECORD_ACTIONS.ERASE&&e.originalAction!==s.RECORD_ACTIONS.DELETE&&e.originalAction!==s.RECORD_ACTIONS.CREATE&&e.originalAction!==s.RECORD_ACTIONS.READ||this.emit(o.EVENT.RECORD_ERROR,s.RECORD_ACTIONS[s.RECORD_ACTIONS.MESSAGE_DENIED],s.RECORD_ACTIONS[e.originalAction]),void(e.originalAction===s.RECORD_ACTIONS.DELETE&&(this.deleteResponse.callback?this.deleteResponse.callback(s.RECORD_ACTIONS[s.RECORD_ACTIONS.MESSAGE_DENIED]):this.deleteResponse.reject&&this.deleteResponse.reject(s.RECORD_ACTIONS[s.RECORD_ACTIONS.MESSAGE_DENIED])));if(e.action!==s.RECORD_ACTIONS.WRITE_ACKNOWLEDGEMENT)return e.action===s.RECORD_ACTIONS.SUBSCRIPTION_HAS_PROVIDER||e.action===s.RECORD_ACTIONS.SUBSCRIPTION_HAS_NO_PROVIDER?(this.hasProvider=e.action===s.RECORD_ACTIONS.SUBSCRIPTION_HAS_PROVIDER,void this.emit(o.EVENT.RECORD_HAS_PROVIDER_CHANGED,this.hasProvider)):void 0;this.handleWriteAcknowledgements(e)}}else this.applyUpdate(e)}},{key:"sendRead",value:function(){this.services.connection.sendMessage({topic:s.TOPIC.RECORD,action:s.RECORD_ACTIONS.READ,name:this.name})}},{key:"handleWriteAcknowledgements",value:function(e){for(var t=e.parsedData[0],n=e.parsedData[1],i=0;i<t.length;i++){var r=t[i],o=this.writeCallbacks.get(r);o&&(this.writeCallbacks.delete(r),o(n))}}},{key:"saveUpdate",value:function(){this.offlineDirty||(this.version++,this.offlineDirty=!0),this.services.storage.set(this.name,this.version,this.data,function(){})}},{key:"sendUpdate",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments[1],n=arguments[2];this.version++,void 0!==t||null===e?null!==e?this.services.connection.sendMessage({topic:s.TOPIC.RECORD,action:n?s.RECORD_ACTIONS.PATCH_WITH_WRITE_ACK:s.RECORD_ACTIONS.PATCH,name:this.name,path:e,parsedData:t,version:this.version}):this.services.connection.sendMessage({topic:s.TOPIC.RECORD,action:n?s.RECORD_ACTIONS.UPDATE_WITH_WRITE_ACK:s.RECORD_ACTIONS.UPDATE,name:this.name,parsedData:t,version:this.version}):this.services.connection.sendMessage({topic:s.TOPIC.RECORD,action:n?s.RECORD_ACTIONS.ERASE_WITH_WRITE_ACK:s.RECORD_ACTIONS.ERASE,name:this.name,path:e,version:this.version})}},{key:"applyUpdate",value:function(e){var t=e.version,n=e.parsedData;if(null===this.version)this.version=t;else if(this.version+1!==t)return void(e.action===s.RECORD_ACTIONS.PATCH?this.sendRead():this.recoverRecord(e.version,e.parsedData,e));this.version=t;var i=a.setValue(this.data,e.path||null,n);this.applyChange(i)}},{key:"applyChange",value:function(e){if(!this.stateMachine.inEndState){var t=this.data;this.data=e;for(var n=this.emitter.eventNames(),i=0;i<n.length;i++){a.get(e,n[i],!1)!==a.get(t,n[i],!1)&&this.emitter.emit(n[i],this.get(n[i]))}}}},{key:"sendDelete",value:function(){var e=this;this.whenReady(null,function(){if(e.services.connection.isConnected){var t={topic:s.TOPIC.RECORD,action:s.RECORD_ACTIONS.DELETE,name:e.name};e.deletedTimeout=e.services.timeoutRegistry.add({message:t,event:o.EVENT.RECORD_DELETE_TIMEOUT,duration:e.options.recordDeleteTimeout}),e.services.connection.sendMessage(t)}else e.services.storage.delete(e.name,function(){e.services.timerRegistry.requestIdleCallback(function(){e.stateMachine.transition(s.RECORD_ACTIONS.DELETE_SUCCESS)})})})}},{key:"recoverRecord",value:function(e,t,n){this.mergeStrategy?this.mergeStrategy(this,t,e,this.onRecordRecovered.bind(this,e,t,n)):this.services.logger.error(n,o.EVENT.RECORD_VERSION_EXISTS,{remoteVersion:e,record:this})}},{key:"onRecordRecovered",value:function(e,t,n,i,r){i&&this.services.logger.error(n,o.EVENT.RECORD_VERSION_EXISTS);var s=this.version;this.version=e;var c=this.data;if(!E.deepEquals(c,t)){var u=a.setValue(c,null,r);if(E.deepEquals(r,t)){this.applyChange(r);var h=this.writeCallbacks.get(e);void 0!==h&&(h(null),this.writeCallbacks.delete(e))}else{if(n.isWriteAck){var l=this.writeCallbacks.get(s);l&&(this.writeCallbacks.delete(e),this.setupWriteCallback(this.version,l))}this.sendUpdate(null,r,n.isWriteAck),this.applyChange(u)}}}},{key:"checkDestroyed",value:function(e){return!!this.stateMachine.inEndState&&(this.services.logger.error({topic:s.TOPIC.RECORD},o.EVENT.RECORD_ALREADY_DESTROYED,{methodName:e}),!0)}},{key:"setupWriteCallback",value:function(e,t){this.writeCallbacks.set(this.version+1,t)}},{key:"destroy",value:function(){this.services.timerRegistry.remove(this.deletedTimeout),this.services.timerRegistry.remove(this.discardTimeout),this.services.timerRegistry.remove(this.responseTimeout),this.emitter.off(),this.isReady=!1,this.whenComplete(this.name)}},{key:"recordState",get:function(){return this.stateMachine.state}},{key:"usages",set:function(e){this.references=e,1===this.references&&(this.services.timerRegistry.remove(this.discardTimeout),this.stateMachine.transition(s.RECORD_ACTIONS.SUBSCRIBE))},get:function(){return this.references}}]),t}();t.RecordCore=h},function(e,t,n){"use strict";function i(e){if(null===e)return[];for(var t=[],n=e.split("."),i=0;i<n.length;i++){var r=n[i].trim();if(0!==r.length){var o=r.split(s);if(0!==o.length){t.push(o[0]);for(var a=1;a<o.length;a++)0!==o[a].length&&t.push(Number(o[a]))}}}return t}var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Object.defineProperty(t,"__esModule",{value:!0});var o=n(3),s=/[[\]]/g;t.get=function(e,t,n){for(var s=i(t),a=e,c=0;c<s.length;c++){if(void 0===a)return;if("object"!==(void 0===a?"undefined":r(a)))throw new Error("invalid data or path");a=a[s[c]]}return!1!==n?o.deepCopy(a):a},t.setValue=function(e,t,n){if(null===t)return n;var s=i(t),a=o.deepCopy(e),c=a,E=void 0;for(E=0;E<s.length-1;E++){var u=s[E];c=void 0!==c[u]&&"object"===r(c[u])?c[u]:"number"==typeof s[E+1]?c[u]=[]:c[u]={}}return void 0===n?delete c[s[E]]:c[s[E]]=n,a}},function(e,t,n){"use strict";var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(3),o=n(1),s=n(2),a=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.record=e,n.subscriptions=[],n.record.on(o.EVENT.RECORD_READY,n.emit.bind(n,o.EVENT.RECORD_READY,n)),n.record.on(o.EVENT.RECORD_DISCARDED,n.emit.bind(n,o.EVENT.RECORD_DISCARDED)),n.record.on(o.EVENT.RECORD_DELETED,n.emit.bind(n,o.EVENT.RECORD_DELETED)),n.record.on(o.EVENT.RECORD_ERROR,n.emit.bind(n,o.EVENT.RECORD_ERROR)),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,s),i(t,[{key:"whenReady",value:function(e){return this.record.whenReady(this,e)}},{key:"get",value:function(e){return this.record.get(e)}},{key:"set",value:function(e,t,n){return this.record.set(r.normalizeSetArguments(arguments))}},{key:"setWithAck",value:function(e,t,n){return this.record.setWithAck(r.normalizeSetArguments(arguments))}},{key:"subscribe",value:function(e,t,n){var i=r.normalizeArguments(arguments);this.subscriptions.push(i),this.record.subscribe(i)}},{key:"unsubscribe",value:function(e,t){var n=r.normalizeArguments(arguments);this.subscriptions=this.subscriptions.filter(function(e){return e.path!==n.path||e.callback!==n.callback}),this.record.unsubscribe(n)}},{key:"discard",value:function(){for(var e=0;e<this.subscriptions.length;e++)this.record.unsubscribe(this.subscriptions[e]);return this.record.discard()}},{key:"delete",value:function(e){return this.record.delete(e)}},{key:"setMergeStrategy",value:function(e){this.record.setMergeStrategy(e)}},{key:"name",get:function(){return this.record.name}},{key:"isReady",get:function(){return this.record.isReady}},{key:"version",get:function(){return this.record.version}}]),t}();t.Record=a},function(e,t,n){"use strict";var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(3),o=n(2),s=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.record=null,n.subscriptions=[],n.getRecordCore=e,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,o),i(t,[{key:"whenReady",value:function(e){if(this.record)return this.record.whenReady(this,e)}},{key:"setName",value:function(e,t){if(this.name!==e){this.discard(),this.record=this.getRecordCore(e);for(var n=0;n<this.subscriptions.length;n++)this.record.subscribe(this.subscriptions[n]);return this.emit("nameChanged",e),this.record.whenReady(this,t)}}},{key:"get",value:function(e){if(this.record)return this.record.get(e)}},{key:"set",value:function(e,t,n){if(this.record)return this.record.set(r.normalizeSetArguments(arguments))}},{key:"setWithAck",value:function(e,t,n){if(this.record)return this.record.setWithAck(r.normalizeSetArguments(arguments))}},{key:"subscribe",value:function(e,t,n){var i=r.normalizeArguments(arguments);this.subscriptions.push(i),this.record&&this.record.subscribe(i)}},{key:"unsubscribe",value:function(e,t){var n=r.normalizeArguments(arguments);this.subscriptions=this.subscriptions.filter(function(e){return e.path!==n.path||e.callback!==n.callback}),this.record&&this.record.unsubscribe(n)}},{key:"discard",value:function(){if(this.record){for(var e=0;e<this.subscriptions.length;e++)this.record.unsubscribe(this.subscriptions[e]);return this.record.discard()}}},{key:"delete",value:function(e){if(this.record)return this.record.delete(e)}},{key:"setMergeStrategy",value:function(e){this.record&&this.record.setMergeStrategy(e)}},{key:"name",get:function(){return this.record?this.record.name:""}},{key:"isReady",get:function(){return!!this.record&&this.record.isReady}},{key:"version",get:function(){return this.record?this.record.version:-1}}]),t}();t.AnonymousRecord=s},function(e,t,n){"use strict";var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(3),o=n(1),s=n(2),a=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.record=e,n.originalApplyUpdate=n.record.applyUpdate.bind(n.record),n.record.applyUpdate=n.applyUpdate.bind(n),n.wrappedFunctions=new Map,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,s),i(t,[{key:"whenReady",value:function(e){return this.record.whenReady(this,e)}},{key:"getEntries",value:function(){var e=this.record.get();return e instanceof Array?e:[]}},{key:"isEmpty",value:function(){return 0===this.getEntries().length}},{key:"setEntriesWithAck",value:function(e,t){var n=this;if(!t)return new Promise(function(t,i){n.setEntries(e,function(e){e?i(e):t()})});this.setEntries(e,t)}},{key:"setEntries",value:function(e,t){var n="entries must be an array of record names",i=void 0;if(!(e instanceof Array))throw new Error(n);for(i=0;i<e.length;i++)if("string"!=typeof e[i])throw new Error(n);!1===this.record.isReady||(this.beforeChange(),this.record.set({data:e,callback:t}),this.afterChange())}},{key:"removeEntry",value:function(e,t,n){if(!1!==this.record.isReady){var i=this.record.get(),r=this.hasIndex(t),o=[],s=void 0;for(s=0;s<i.length;s++)(i[s]!==e||r&&t!==s)&&o.push(i[s]);this.beforeChange(),this.record.set({data:o,callback:n}),this.afterChange()}}},{key:"addEntry",value:function(e,t,n){if("string"!=typeof e)throw new Error("Entry must be a recordName");if(!1!==this.record.isReady){var i=this.hasIndex(t),r=this.getEntries();i?r.splice(t,0,e):r.push(e),this.beforeChange(),this.record.set({data:r,callback:n}),this.afterChange()}}},{key:"subscribe",value:function(e){var t=r.normalizeArguments(arguments);if(t.path)throw new Error("path is not supported for List.subscribe");var n=function(e){e(this.getEntries())}.bind(this,t.callback);this.wrappedFunctions.set(t.callback,n),t.callback=n,this.record.subscribe(t)}},{key:"unsubscribe",value:function(e){var t=r.normalizeArguments(arguments);if(t.path)throw new Error("path is not supported for List.unsubscribe");var n=this.wrappedFunctions.get(t.callback);t.callback=n,this.record.unsubscribe(t),this.wrappedFunctions.delete(t.callback)}},{key:"applyUpdate",value:function(e){e.parsedData instanceof Array||(e.parsedData=[]),this.beforeChange(),this.originalApplyUpdate(e),this.afterChange()}},{key:"hasIndex",value:function(e){var t=!1,n=this.getEntries();if(void 0!==e){if(isNaN(e))throw new Error("Index must be a number");if(e!==n.length&&(e>=n.length||e<0))throw new Error("Index must be within current entries");t=!0}return t}},{key:"beforeChange",value:function(){this.hasAddListener=this.listeners(o.EVENT.ENTRY_ADDED_EVENT).length>0,this.hasRemoveListener=this.listeners(o.EVENT.ENTRY_REMOVED_EVENT).length>0,this.hasMoveListener=this.listeners(o.EVENT.ENTRY_MOVED_EVENT).length>0,this.hasAddListener||this.hasRemoveListener||this.hasMoveListener?this.beforeStructure=this.getStructure():this.beforeStructure=null}},{key:"afterChange",value:function(){if(null!==this.beforeStructure){var e=this.getStructure(),t=this.beforeStructure,n=void 0,i=void 0;if(this.hasRemoveListener)for(n in t)for(i=0;i<t[n].length;i++)void 0!==e[n]&&void 0!==e[n][i]||this.emit(o.EVENT.ENTRY_REMOVED_EVENT,n,t[n][i]);if(this.hasAddListener||this.hasMoveListener)for(n in e)if(void 0===t[n])for(i=0;i<e[n].length;i++)this.emit(o.EVENT.ENTRY_ADDED_EVENT,n,e[n][i]);else for(i=0;i<e[n].length;i++)t[n][i]!==e[n][i]&&(void 0===t[n][i]?this.emit(o.EVENT.ENTRY_ADDED_EVENT,n,e[n][i]):this.emit(o.EVENT.ENTRY_MOVED_EVENT,n,e[n][i]))}}},{key:"getStructure",value:function(){var e={},t=void 0,n=this.record.get();for(t=0;t<n.length;t++)void 0===e[n[t]]?e[n[t]]=[t]:e[n[t]].push(t);return e}},{key:"name",get:function(){return this.record.name}},{key:"isReady",get:function(){return this.record.isReady}},{key:"version",get:function(){return this.record.version}}]),t}();t.List=a},function(e,t,n){"use strict";var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(4),o=function(){function e(t,n,i,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.services=t,this.topic=n,this.action=i,this.timeoutDuration=r,this.requests=new Map}return i(e,[{key:"request",value:function(e,t){if(!1!==this.services.connection.isConnected){var n={topic:this.topic,action:this.action,name:e};this.services.timeoutRegistry.add({message:n});var i=this.requests.get(e);void 0===i?(this.requests.set(e,[t]),this.services.connection.sendMessage(n)):i.push(t)}else t.callback?this.services.timerRegistry.requestIdleCallback(t.callback.bind(this,r.EVENT.CLIENT_OFFLINE)):t.reject&&t.reject(r.EVENT.CLIENT_OFFLINE)}},{key:"recieve",value:function(e,t,n){var i=e.name,o=this.requests.get(i);if(o){for(var s=0;s<o.length;s++){var a=o[s];a.callback?a.callback(t,n):t&&a.reject?a.reject(t):a.resolve&&a.resolve(n)}this.requests.delete(i)}else this.services.logger.error(e,r.EVENT.UNSOLICITED_MESSAGE)}}]),e}();t.SingleNotifier=o},function(e,t,n){"use strict";var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(4),o=n(0),s=n(2),a=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.services=t,this.options=n,this.subscriptionEmitter=new s,this.globalSubscriptionEmitter=new s,this.queryEmitter=new s,this.queryAllEmitter=new s,this.resubscribe=this.resubscribe.bind(this),this.services.connection.registerHandler(o.TOPIC.PRESENCE,this.handle.bind(this)),this.services.connection.onReestablished(this.resubscribe.bind(this)),this.counter=0,this.pendingSubscribes=new Set,this.pendingUnsubscribes=new Set}return i(e,[{key:"subscribe",value:function(e,t){if("string"==typeof e&&e.length>0&&"function"==typeof t){var n=e;return this.subscriptionEmitter.hasListeners(n)||this.pendingSubscribes.add(n),this.subscriptionEmitter.on(n,t),this.pendingUnsubscribes.delete(n),void this.registerFlushTimeout()}if("function"==typeof e&&void 0===t)return this.subscriptionEmitter.hasListeners("OE")||this.subscribeToAllChanges(),void this.globalSubscriptionEmitter.on("OE",e);throw new Error('invalid arguments: "user" or "callback"')}},{key:"unsubscribe",value:function(e,t){if(!(e&&"string"==typeof e&&e.length>0)){if(e&&"function"==typeof e)return t=e,this.globalSubscriptionEmitter.off("OE",t),void(this.subscriptionEmitter.hasListeners("OE")||this.unsubscribeToAllChanges());if(void 0===e&&void 0===t){this.subscriptionEmitter.off(),this.globalSubscriptionEmitter.off(),this.pendingSubscribes.clear();for(var n=this.subscriptionEmitter.eventNames(),i=0;i<n.length;i++)this.pendingUnsubscribes.add(n[i]);return this.registerFlushTimeout(),void this.unsubscribeToAllChanges()}throw new Error('invalid argument: "user" or "callback"')}var r=e;if(t){if("function"!=typeof t)throw new Error('invalid argument: "callback"');this.subscriptionEmitter.off(r,t)}else this.subscriptionEmitter.off(r);this.subscriptionEmitter.hasListeners(r)||(this.pendingSubscribes.delete(r),this.pendingUnsubscribes.add(r),this.registerFlushTimeout())}},{key:"getAll",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=function(e){var t=null,n=null;if(1===e.length)if(Array.isArray(e[0]))t=e[0];else{if("function"!=typeof e[0])throw new Error('invalid argument: "callback"');n=e[0]}else if(2===e.length&&(t=e[0],n=e[1],!Array.isArray(t)||"function"!=typeof n))throw new Error('invalid argument: "users" or "callback"');return{users:t,callback:n}}(t),s=i.callback,a=i.users;if(!this.services.connection.isConnected)return s?void this.services.timerRegistry.requestIdleCallback(s.bind(this,r.EVENT.CLIENT_OFFLINE)):Promise.reject(r.EVENT.CLIENT_OFFLINE);var c=void 0,E=void 0,u=void 0;if(a){var h=(this.counter++).toString();c={topic:o.TOPIC.PRESENCE,action:o.PRESENCE_ACTIONS.QUERY,correlationId:h,names:a},E=this.queryEmitter,u=h}else c={topic:o.TOPIC.PRESENCE,action:o.PRESENCE_ACTIONS.QUERY_ALL},E=this.queryAllEmitter,u="OE";if(this.services.connection.sendMessage(c),this.services.timeoutRegistry.add({message:c}),!s)return new Promise(function(e,t){E.once(u,function(n,i){n?t(n):e(i)})});E.once(u,s)}},{key:"handle",value:function(e){if(e.isAck)this.services.timeoutRegistry.remove(e);else{if(e.action===o.PRESENCE_ACTIONS.QUERY_ALL_RESPONSE)return this.queryAllEmitter.emit("OE",null,e.names),void this.services.timeoutRegistry.remove(Object.assign({},e,{action:o.PRESENCE_ACTIONS.QUERY_ALL}));if(e.action===o.PRESENCE_ACTIONS.QUERY_RESPONSE)return this.queryEmitter.emit(e.correlationId,null,e.parsedData),void this.services.timeoutRegistry.remove(Object.assign({},e,{action:o.PRESENCE_ACTIONS.QUERY}));if(e.action!==o.PRESENCE_ACTIONS.PRESENCE_JOIN)if(e.action!==o.PRESENCE_ACTIONS.PRESENCE_JOIN_ALL)if(e.action!==o.PRESENCE_ACTIONS.PRESENCE_LEAVE){if(e.action!==o.PRESENCE_ACTIONS.PRESENCE_LEAVE_ALL)return e.isError?(this.services.timeoutRegistry.remove(e),void(e.originalAction===o.PRESENCE_ACTIONS.QUERY?this.queryEmitter.emit(e.correlationId,o.PRESENCE_ACTIONS[e.action]):e.originalAction===o.PRESENCE_ACTIONS.QUERY_ALL?this.queryAllEmitter.emit("OE",o.PRESENCE_ACTIONS[e.action]):this.services.logger.error(e))):void this.services.logger.error(e,r.EVENT.UNSOLICITED_MESSAGE);this.globalSubscriptionEmitter.emit("OE",e.name,!1)}else this.subscriptionEmitter.emit(e.name,e.name,!1);else this.globalSubscriptionEmitter.emit("OE",e.name,!0);else this.subscriptionEmitter.emit(e.name,e.name,!0)}}},{key:"flush",value:function(){if(this.services.connection.isConnected){var e=Array.from(this.pendingSubscribes.keys());e.length>0&&(this.bulkSubscription(o.PRESENCE_ACTIONS.SUBSCRIBE,e),this.pendingSubscribes.clear());var t=Array.from(this.pendingUnsubscribes.keys());t.length>0&&(this.bulkSubscription(o.PRESENCE_ACTIONS.UNSUBSCRIBE,t),this.pendingUnsubscribes.clear()),this.flushTimeout=null}}},{key:"resubscribe",value:function(){var e=this.subscriptionEmitter.eventNames();e.length>0&&this.bulkSubscription(o.PRESENCE_ACTIONS.SUBSCRIBE,e);this.globalSubscriptionEmitter.hasListeners("OE")&&this.subscribeToAllChanges()}},{key:"bulkSubscription",value:function(e,t){var n=this.counter++,i={topic:o.TOPIC.PRESENCE,action:e,correlationId:n.toString(),names:t};this.services.timeoutRegistry.add({message:i}),this.services.connection.sendMessage(i)}},{key:"subscribeToAllChanges",value:function(){if(this.services.connection.isConnected){var e={topic:o.TOPIC.PRESENCE,action:o.PRESENCE_ACTIONS.SUBSCRIBE_ALL};this.services.timeoutRegistry.add({message:e}),this.services.connection.sendMessage(e)}}},{key:"unsubscribeToAllChanges",value:function(){if(this.services.connection.isConnected){var e={topic:o.TOPIC.PRESENCE,action:o.PRESENCE_ACTIONS.UNSUBSCRIBE_ALL};this.services.timeoutRegistry.add({message:e}),this.services.connection.sendMessage(e)}}},{key:"registerFlushTimeout",value:function(){this.flushTimeout||(this.flushTimeout=this.services.timerRegistry.add({duration:0,context:this,callback:this.flush}))}}]),e}();t.PresenceHandler=a}]);